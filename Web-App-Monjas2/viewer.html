<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#0f1115" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <title>Museo Virtual San JoaquÃ­n y Santa Ana</title>

  <!-- <link rel="prefetch" href="/assets/posters/desktop/cristo-yacente.webp" as="image"> -->
  <link rel="prefetch" href="/assets/audio/cristo-yacente.mp3" as="audio">

  <!-- Preload fuentes crÃ­ticas -->
  <link rel="preload" href="https://fonts.gstatic.com/s/poppins/v20/pxiByp8kv8JHgFVrLGT9Z1xlFQ.woff2" as="font"
    type="font/woff2" crossorigin>
  <link rel="preload" href="https://fonts.gstatic.com/s/lora/v32/0QI6MX1D_JOuGQbT0gvTJPa787weuxJBkq0.woff2" as="font"
    type="font/woff2" crossorigin>

  <!-- Preconnect (mejora de rendimiento fuentes) -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

  <!-- TipografÃ­a para tÃ­tulos -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600&display=swap" rel="stylesheet" media="print"
    onload="this.media='all'">
  <noscript>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght=600&display=swap" rel="stylesheet">
  </noscript>

  <!-- CSS principal -->
  <link rel="stylesheet" href="/index.min.css" />

  <!-- Datos/metadatos -->
  <link rel="preload" href="/assets/info.json" as="fetch" type="application/json" crossorigin="anonymous" />

  <!-- HDR / skybox -->
  <link rel="preload" as="image" href="/assets/hdr/studio_small_09_2k.hdr" />
  <link rel="manifest" href="/manifest.webmanifest">

  <!-- model-viewer (GLB) -->
  <script type="module" src="/vendor/model-viewer-4.0.0.min.js"></script>

  <!-- === FAVICON UNIVERSAL === -->
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/icons/favicon.png">
  <link rel="apple-touch-icon" href="/assets/icons/favicon.png">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0f1115">

  <!-- TipografÃ­a clÃ¡sica para cuerpo de texto -->
  <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;500;600&display=swap" rel="stylesheet">

</head>

<body>
  <!-- =========================
         Topbar
         ========================= -->
  <header id="topBar">
    <!-- IZQUIERDA: Flecha + Isotipo -->
    <div class="left-group">
      <a class="back-btn" href="/" aria-label="Volver atrÃ¡s">
        <!-- Flecha minimalista -->
        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
      </a>

      <!-- Isotipo (solo mÃ³vil) -->
      <img id="brandMark" src="/assets/brand/isotipo.svg" alt="Museo Virtual" />

      <!-- Logotipo completo (solo escritorio) -->
      <img id="brandLogo" src="/assets/brand/logo-museo.svg" alt="Museo Virtual San JoaquÃ­n y Santa Ana" />
    </div>

    <!-- TÃTULO a la derecha del botÃ³n back -->
    <div class="title-wrapper">
      <h1 id="pieceTitle">Cristo Yacente</h1>
    </div>

    <!-- DERECHA: BotÃ³n Info (mÃ³vil) / GalerÃ­a (escritorio) -->
    <button id="infoBtn" class="info-btn" type="button" aria-controls="infoSheet" aria-expanded="false">
      InformaciÃ³n
    </button>
    <a class="gallery-btn" href="/">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 10L12 3l9 7"></path>
        <line x1="4" y1="10" x2="20" y2="10"></line>
        <line x1="4" y1="22" x2="20" y2="22"></line>
        <line x1="6" y1="10" x2="6" y2="22"></line>
        <line x1="10" y1="10" x2="10" y2="22"></line>
        <line x1="14" y1="10" x2="14" y2="22"></line>
        <line x1="18" y1="10" x2="18" y2="22"></line>
      </svg>
      Ir al Museo
    </a>
  </header>

  <!-- Ayuda de atajos (desktop) -->
  <div id="kbdHelp" class="kbd-help hidden" aria-hidden="true">
    <div class="kbd-help__row"><kbd>Arrastrar</kbd> Rotar</div>
    <div class="kbd-help__row"><kbd>Shift</kbd> + arrastrar â€” Pan</div>
    <div class="kbd-help__row"><kbd>Rueda</kbd> â€” Zoom</div>
    <div class="kbd-help__row"><kbd>H</kbd> â€” Mostrar/ocultar ayuda</div>
  </div>

  <!-- Mensaje si faltan parÃ¡metros -->
  <div id="msg" class="hidden"></div>

  <!-- =========================
         Overlay skeleton (carga)
         ========================= -->
  <div id="skel" class="skeleton">
    <div class="loader-container">
      <div class="loader-circle">
        <div class="loader-progress" id="loaderProgress">0%</div>
      </div>
      <p class="loader-text">
        Cargando experiencia,<br />
        puede tardar un poco segÃºn tu conexiÃ³n
      </p>
    </div>
  </div>

  <!-- =========================
         Vista GLB
         ========================= -->
  <!-- CONTENEDOR EXCLUSIVO DE ESCRITORIO -->
  <div id="viewerContainer" class="desktop-only">
    <model-viewer id="mv" class="hidden" loading="lazy" alt="Modelo 3D" camera-controls touch-action="pan-y" ar
      ar-modes="webxr scene-viewer quick-look" ar-scale="fixed" ar-placement="floor" environment-image="neutral"
      shadow-intensity="1.2" shadow-softness="0.9" exposure="1" camera-orbit="0deg 70deg 1.5m" field-of-view="30deg">
    </model-viewer>

    <div class="glb-poster" id="glbPoster"></div>
    <div class="splat-poster" id="splatPoster"></div>
    <iframe id="splat" class="hidden" loading="lazy"
      allow=" autoplay; fullscreen; xr-spatial-tracking; camera; microphone; gyroscope; accelerometer">
    </iframe>
  </div>


  <!-- CARTELA EXCLUSIVA ESCRITORIO -->
  <aside id="infoPanel" class="desktop-only">
    <div class="info-content">
      <h2 id="infoTitleDesktop">Cristo Yacente</h2>
      <p class="info-meta">Siglo XVIII (1740) â€” Luis Salvador Carmona â€” Madera</p>
      <p class="info-desc">
        Escultura barroca en madera policromada que representa el cuerpo de Cristo tras su descendimiento.
      </p>

      <ul class="info-details">
        <li><strong>TipologÃ­a:</strong> Madera policromada</li>
        <li><strong>Material:</strong> Madera</li>
        <li><strong>Fecha:</strong> Siglo XVIII (1740)</li>
        <li><strong>Autor:</strong> Luis Salvador Carmona</li>
      </ul>
      <div class="info-actions">
        <button id="audioGuideBtn" class="info-btn-audio">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="5 3 19 12 5 21 5 3"></polygon>
          </svg>
          Escuchar audioguÃ­a
        </button>

        <a href="/" class="info-btn-visit">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
            <polyline points="16 6 12 2 8 6"></polyline>
            <line x1="12" y1="2" x2="12" y2="15"></line>
          </svg>
          Web ClÃ¡sica
        </a>
      </div>
    </div>
  </aside>

  <!-- =========================
         FABs (Audio + AR)
         ========================= -->
  <div id="fabRow" class="fab-row">
    <!-- AUDIO (izquierda) -->
    <button id="audioBtn" class="audio-fab hidden" type="button" aria-label="Reproducir audio" aria-pressed="false">
      <!-- Icono ALTAVOZ (parado) -->
      <svg class="icon-play" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M4 9v6h3l5 4V5L7 9H4z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"
          stroke-linejoin="round" />
        <path d="M15 10.5a3.5 3.5 0 010 3" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />
        <path d="M17.5 8a6 6 0 010 8" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />
      </svg>
      <!-- Icono PAUSA (reproduciendo) -->
      <svg class="icon-pause" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <rect x="6" y="5" width="4" height="14" rx="1.2" stroke="currentColor" stroke-width="1.8" />
        <rect x="14" y="5" width="4" height="14" rx="1.2" stroke="currentColor" stroke-width="1.8" />
      </svg>
    </button>

    <!-- AR (derecha) -->
    <button id="arBtn" class="ar-fab hidden" type="button" aria-label="Ver en AR">
      <!-- Spinner de carga (oculto por defecto) -->
      <svg class="ar-spinner" viewBox="0 0 24 24" fill="none" style="display: none;">
        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" stroke-linecap="round"
          stroke-dasharray="60" stroke-dashoffset="15" opacity="0.3" />
        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" stroke-linecap="round"
          stroke-dasharray="60" stroke-dashoffset="15">
          <animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="1s"
            repeatCount="indefinite" />
        </circle>
      </svg>
      <!-- Icono AR normal -->
      <svg class="ar-icon" viewBox="0 0 24 24" fill="none">
        <path d="M12 3l8.66 5v8L12 21l-8.66-5V8L12 3zM12 3v18M3.34 8L12 13l8.66-5" stroke="white" stroke-width="1.8"
          stroke-linecap="round" stroke-linejoin="round" />
      </svg>
      <span class="ar-text">Ver en AR</span>
    </button>
  </div>
  <!-- =========================
         Overlay de carga AR
         ========================= -->
  <div id="arLoading" class="ar-loading hidden" aria-hidden="true">
    <div class="spinner" aria-hidden="true"></div>
    <span id="arLoadingText">Preparando experiencia ARâ€¦</span>
  </div>

  <!-- =========================
         Cartela (Info Sheet)
         ========================= -->
  <div id="infoSheet" class="info-sheet hidden" aria-hidden="true">
    <div class="info-sheet__drag"></div>
    <button id="infoClose" class="info-sheet__close" aria-label="Cerrar">âœ•</button>
    <div class="info-sheet__content">
      <h2 id="infoTitle">Obra</h2>
      <p class="info-meta" id="infoMeta"></p>
      <p class="info-desc" id="infoDesc"></p>
    </div>
  </div>

  <!-- Link AR iOS oculto -->
  <a id="iosARLink" rel="ar" style="display:none" aria-hidden="true"></a>

  <!-- =========================
         Script principal (sin eliminar nada, solo organizado)
         ========================= -->
  <script>
    function prefetchCommonAssets() {
      const commonAssets = [
        '/assets/info.json',
        '/assets/brand/logo-museo.svg',
        '/assets/brand/isotipo.svg',
        '/index.css',
        '/sw.js'
      ];

      commonAssets.forEach(url => {
        const link = document.createElement('link');
        link.rel = 'prefetch';
        link.href = url;
        document.head.appendChild(link);
      });
    }

    window.addEventListener('load', prefetchCommonAssets);

    // ========================================
// LOGICA UNIFICADA DE VISOR (v3.1 - MÃXIMA ROBUSTEZ)
// ========================================

// --- Helpers Globales (Inyectados en Window) ---
window.loadInfoForSlug = function (slug, lang) {
    const infoPath = `/assets/info${lang === 'en' ? '_en' : ''}.json`;
    fetch(infoPath)
        .then(res => res.json())
        .then(infoData => {
            const info = infoData[slug];
            if (!info) return;

            // MÃ³vil
            const infoTitle = document.getElementById('infoTitle');
            const infoMeta = document.getElementById('infoMeta');
            const infoDesc = document.getElementById('infoDesc');
            if (infoTitle) infoTitle.textContent = info.title;
            if (infoMeta) infoMeta.textContent = `${info.year} â€” ${info.author} â€” ${info.material}`;
            if (infoDesc) infoDesc.textContent = info.desc;

            // Escritorio
            const infoTitleDesktop = document.getElementById('infoTitleDesktop');
            const infoMetaDesktop = document.querySelector('#infoPanel .info-meta');
            const infoDescDesktop = document.querySelector('#infoPanel .info-desc');
            const infoDetails = document.querySelector('#infoPanel .info-details');

            if (infoTitleDesktop) infoTitleDesktop.textContent = info.title;
            if (infoMetaDesktop) infoMetaDesktop.textContent = `${info.year} â€” ${info.author} â€” ${info.material}`;
            if (infoDescDesktop) infoDescDesktop.textContent = info.desc;
            if (infoDetails) {
                infoDetails.innerHTML = `
            <li><strong>${lang === 'en' ? 'Typology' : 'TipologÃ­a'}:</strong> ${info.typology || 'â€”'}</li>
            <li><strong>${lang === 'en' ? 'Material' : 'Material'}:</strong> ${info.material || 'â€”'}</li>
            <li><strong>${lang === 'en' ? 'Date' : 'Fecha'}:</strong> ${info.year || 'â€”'}</li>
            <li><strong>${lang === 'en' ? 'Author' : 'Autor'}:</strong> ${info.author || 'â€”'}</li>
          `;
            }
            console.log(`[Museo] Info cargada para ${slug} (${lang})`);
        })
        .catch(err => console.error('[Museo] Error cargando info.json:', err));
};

window.setupAudioFor = function (slug) {
    const audioBtn = document.getElementById('audioBtn');
    if (!audioBtn) return;

    const audioPath = `/assets/audio/${slug}.mp3`;
    const audio = new Audio(audioPath);
    let isPlaying = false;

    audioBtn.classList.remove('hidden');
    audioBtn.onclick = () => {
        if (isPlaying) {
            audio.pause();
            isPlaying = false;
            audioBtn.setAttribute('aria-pressed', 'false');
            audioBtn.classList.remove('playing');
        } else {
            audio.play().catch(e => console.warn('Audio play failed:', e));
            isPlaying = true;
            audioBtn.setAttribute('aria-pressed', 'true');
            audioBtn.classList.add('playing');
        }
    };

    audio.onended = () => {
        isPlaying = false;
        audioBtn.setAttribute('aria-pressed', 'false');
        audioBtn.classList.remove('playing');
    };
};

window.openARFor = function (slug) {
    // ImplementaciÃ³n genÃ©rica para Android (Scene Viewer)
    const intent = `intent://arvr.google.com/scene-viewer/1.0?file=${encodeURIComponent(`https://www.museovirtualsantana.es/models/${slug}/${slug}.glb`)}&mode=ar_preferred&title=${encodeURIComponent(slug)}#Intent;scheme=https;package=com.google.android.googlequicksearchbox;action=android.intent.action.VIEW;end;`;
    window.location.href = intent;
};

window.openQuickLookSync = function (slug) {
    // ImplementaciÃ³n sencilla para iOS
    const a = document.createElement('a');
    a.setAttribute('rel', 'ar');
    a.setAttribute('href', `/models/${slug}/${slug}.usdz`);
    a.appendChild(document.createElement('img'));
    a.click();
    return true;
};


// --- InicializaciÃ³n Principal ---
(async function initViewer() {
    // 1. Parsing de URL
    const qs = new URLSearchParams(window.location.search);
    let type = (qs.get('type') || '').toLowerCase();
    let model = (qs.get('model') || '').toLowerCase();
    let figure = (qs.get('figure') || '').toLowerCase();

    // Soporte para rutas limpias /glb/slug o /splat/slug
    if (!type) {
        const parts = window.location.pathname.split('/').filter(Boolean);
        if (parts[0] === 'splat' && parts[1]) { type = 'splat'; figure = parts[1]; }
        else if (parts[0] === 'glb' && parts[1]) { type = 'glb'; model = parts[1]; }
        else if (parts.length === 1) { type = 'glb'; model = parts[0]; }
    }

    // Defaults
    if (!type && (model || figure)) type = figure ? 'splat' : 'glb';
    if (!model && !figure) { type = 'glb'; model = 'cristo-yacente'; }
    const slug = model || figure;

    console.log('ðŸŒ [Visor] Iniciando:', { type, slug });

    // 2. Elementos DOM
    const mv = document.getElementById('mv');
    const splat = document.getElementById('splat');
    const skel = document.getElementById('skel');
    const msg = document.getElementById('msg');
    const infoPanel = document.getElementById('infoPanel');
    const arBtn = document.getElementById('arBtn');
    let loaded = false;

    // 3. Helpers de URL
    const glbUrl = (name) => `/models/${name}/${name}.glb`;
    const usdzUrl = (name) => `/models/${name}/${name}.usdz`;

    // 4. IluminaciÃ³n
    const HDR_URL = '/assets/hdr/studio_small_09_2k.hdr';
    const applyLighting = (el) => {
        el.setAttribute('environment-image', HDR_URL);
        el.setAttribute('skybox-image', '');
        el.exposure = 1.0;
        el.shadowIntensity = 1.5;
        el.shadowSoftness = 0.8;
    };

    // Failsafe: Watchdog para ocultar carga si falla
    setTimeout(() => {
        if (!loaded && skel && !skel.classList.contains('hidden')) {
            console.warn('[Visor] Watchdog: Forzando ocultar carga tras 4s...');
            skel.classList.add('hidden');
            if (mv) {
                mv.classList.remove('hidden');
                mv.classList.add('is-visible');
            }
        }
    }, 4000);

    // 5. LÃ³gica de Carga GLB
    if (type === 'glb') {
        document.body.classList.remove('mode-splat');
        if (splat) splat.remove();

        mv.src = glbUrl(slug);
        mv.iosSrc = usdzUrl(slug);

        // Poster bÃ¡sico
        mv.poster = `/assets/posters/${slug}.webp`;

        applyLighting(mv);
        mv.addEventListener('load', () => {
            loaded = true;
            applyLighting(mv);
            if (skel) skel.classList.add('hidden');
            mv.classList.remove('hidden');
            mv.classList.add('is-visible');
        });

        // ConfiguraciÃ³n cÃ¡mara
        if (window.cameraSettings && window.cameraSettings[slug]) {
            const cam = window.cameraSettings[slug];
            if (cam.orbit) mv.cameraOrbit = cam.orbit;
            if (cam.fov) mv.fieldOfView = cam.fov;
        }

        // Setup botÃ³n AR
        if (arBtn) {
            arBtn.classList.remove('hidden');
            arBtn.onclick = () => {
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                if (isIOS) window.openQuickLookSync(slug);
                else window.openARFor(slug);
            }
        }
    }

    // 6. LÃ³gica de Carga Splat
    else if (type === 'splat') {
        document.body.classList.add('mode-splat');
        if (mv) mv.remove();

        if (splat) {
            splat.src = `/splat/${slug}/viewer.html?noui=1`;
            splat.classList.remove('hidden');

            splat.onload = () => {
                loaded = true;
                if (skel) skel.classList.add('hidden');
            };
        }
    }

    // 7. Cargar InformaciÃ³n
    window.loadInfoForSlug(slug, localStorage.getItem('museum-lang') || 'es');

    // 8. Setup Audio
    window.setupAudioFor(slug);

})();
  </script>
  <!-- ==== REGISTRO DEL SERVICE WORKER ==== -->
  <script>
    // --- Swipe down para cerrar la cartela mÃ³vil ---
    (function () {
      const sheet = document.getElementById('infoSheet');
      const dragHandle = document.querySelector('.info-sheet__drag');
      if (!sheet || !dragHandle) return;

      let startY = 0;
      let currentY = 0;
      let isDragging = false;

      const onTouchStart = (e) => {
        startY = e.touches[0].clientY;
        isDragging = true;
        sheet.style.transition = 'none';
      };

      const onTouchMove = (e) => {
        if (!isDragging) return;
        currentY = e.touches[0].clientY;
        const diff = currentY - startY;

        // Solo desplazamos hacia abajo
        if (diff > 0) {
          sheet.style.transform = `translateY(${diff}px)`;
          sheet.style.opacity = `${Math.max(1 - diff / 300, 0.4)}`;
        }
      };

      const onTouchEnd = () => {
        if (!isDragging) return;
        isDragging = false;
        sheet.style.transition = 'transform 0.25s ease, opacity 0.25s ease';

        const diff = currentY - startY;
        if (diff > 120) {
          // cerrar cartela
          sheet.classList.add('hidden');
          sheet.setAttribute('aria-hidden', 'true');
          document.body.classList.remove('sheet-open');
        } else {
          // volver a su sitio
          sheet.style.transform = '';
          sheet.style.opacity = '';
        }
      };

      dragHandle.addEventListener('touchstart', onTouchStart);
      dragHandle.addEventListener('touchmove', onTouchMove);
      dragHandle.addEventListener('touchend', onTouchEnd);
    })();

    // Registro del Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(reg => console.log('âœ… Service Worker registrado para el visor'))
          .catch(err => console.warn('âŒ Error registrando SW:', err));
      });
    }
  </script>
  <script src="/assets/debug-overlay.js"></script>
</body>

</html>
<script>
  // ========================================
  // HELPERS COOLDOWN VISUAL (Inyectado)
  // ========================================
  window.startCooldownVisual = function (btn) {
    if (!btn) return;
    btn.classList.add('is-cooldown');
    const originalText = btn.querySelector('.ar-text')?.textContent || 'Ver en AR';

    let remaining = Math.ceil(7); // 7s hardcoded por seguridad
    const updateText = () => {
      const txt = btn.querySelector('.ar-text');
      if (txt) txt.textContent = `Espere ${remaining}s...`;
    };

    updateText();

    const interval = setInterval(() => {
      remaining--;
      if (remaining <= 0) {
        clearInterval(interval);
        btn.classList.remove('is-cooldown');
        const txt = btn.querySelector('.ar-text');
        if (txt) txt.textContent = 'Ver en AR';
      } else {
        updateText();
      }
    }, 1000);
  };
</script>


