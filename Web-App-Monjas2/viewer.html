<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#0f1115" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <title>Museo Virtual San JoaquÃ­n y Santa Ana</title>

  <!-- <link rel="prefetch" href="/assets/posters/desktop/cristo-yacente.webp" as="image"> -->
  <link rel="prefetch" href="/assets/audio/cristo-yacente.mp3" as="audio">

  <!-- Preload fuentes crÃ­ticas -->
  <link rel="preload" href="https://fonts.gstatic.com/s/poppins/v20/pxiByp8kv8JHgFVrLGT9Z1xlFQ.woff2" as="font"
    type="font/woff2" crossorigin>
  <link rel="preload" href="https://fonts.gstatic.com/s/lora/v32/0QI6MX1D_JOuGQbT0gvTJPa787weuxJBkq0.woff2" as="font"
    type="font/woff2" crossorigin>

  <!-- Preconnect (mejora de rendimiento fuentes) -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

  <!-- TipografÃ­a para tÃ­tulos -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600&display=swap" rel="stylesheet" media="print"
    onload="this.media='all'">
  <noscript>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght=600&display=swap" rel="stylesheet">
  </noscript>

  <!-- CSS principal -->
  <link rel="stylesheet" href="/index.min.css" />

  <!-- Datos/metadatos -->
  <link rel="preload" href="/assets/info.json" as="fetch" type="application/json" crossorigin="anonymous" />

  <!-- HDR / skybox -->
  <link rel="preload" as="image" href="/assets/hdr/studio_small_09_2k.hdr" />
  <link rel="manifest" href="/manifest.webmanifest">

  <!-- model-viewer (GLB) -->
  <script type="module" src="/vendor/model-viewer-4.0.0.min.js"></script>

  <!-- === FAVICON UNIVERSAL === -->
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/icons/favicon.png">
  <link rel="apple-touch-icon" href="/assets/icons/favicon.png">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0f1115">

  <!-- TipografÃ­a clÃ¡sica para cuerpo de texto -->
  <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;500;600&display=swap" rel="stylesheet">

</head>

<body>
  <!-- =========================
         Topbar
         ========================= -->
  <header id="topBar">
    <!-- IZQUIERDA: Flecha + Isotipo -->
    <div class="left-group">
      <a class="back-btn" href="/" aria-label="Volver atrÃ¡s">
        <!-- Flecha minimalista -->
        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
      </a>

      <!-- Isotipo (solo mÃ³vil) -->
      <img id="brandMark" src="/assets/brand/isotipo.svg" alt="Museo Virtual" />

      <!-- Logotipo completo (solo escritorio) -->
      <img id="brandLogo" src="/assets/brand/logo-museo.svg" alt="Museo Virtual San JoaquÃ­n y Santa Ana" />
    </div>

    <!-- TÃTULO a la derecha del botÃ³n back -->
    <div class="title-wrapper">
      <h1 id="pieceTitle">Cristo Yacente</h1>
    </div>

    <!-- DERECHA: BotÃ³n Info (mÃ³vil) / GalerÃ­a (escritorio) -->
    <button id="infoBtn" class="info-btn" type="button" aria-controls="infoSheet" aria-expanded="false">
      InformaciÃ³n
    </button>
    <a class="gallery-btn" href="/">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 10L12 3l9 7"></path>
        <line x1="4" y1="10" x2="20" y2="10"></line>
        <line x1="4" y1="22" x2="20" y2="22"></line>
        <line x1="6" y1="10" x2="6" y2="22"></line>
        <line x1="10" y1="10" x2="10" y2="22"></line>
        <line x1="14" y1="10" x2="14" y2="22"></line>
        <line x1="18" y1="10" x2="18" y2="22"></line>
      </svg>
      Ir al Museo
    </a>
  </header>

  <!-- Ayuda de atajos (desktop) -->
  <div id="kbdHelp" class="kbd-help hidden" aria-hidden="true">
    <div class="kbd-help__row"><kbd>Arrastrar</kbd> Rotar</div>
    <div class="kbd-help__row"><kbd>Shift</kbd> + arrastrar â€” Pan</div>
    <div class="kbd-help__row"><kbd>Rueda</kbd> â€” Zoom</div>
    <div class="kbd-help__row"><kbd>H</kbd> â€” Mostrar/ocultar ayuda</div>
  </div>

  <!-- Mensaje si faltan parÃ¡metros -->
  <div id="msg" class="hidden"></div>

  <!-- =========================
         Overlay skeleton (carga)
         ========================= -->
  <div id="skel" class="skeleton">
    <div class="loader-container">
      <div class="loader-circle">
        <div class="loader-progress" id="loaderProgress">0%</div>
      </div>
      <p class="loader-text">
        Cargando experiencia,<br />
        puede tardar un poco segÃºn tu conexiÃ³n
      </p>
    </div>
  </div>

  <!-- =========================
         Vista GLB
         ========================= -->
  <!-- CONTENEDOR EXCLUSIVO DE ESCRITORIO -->
  <div id="viewerContainer" class="desktop-only">
    <model-viewer id="mv" class="hidden" loading="lazy" alt="Modelo 3D" camera-controls touch-action="pan-y" ar
      ar-modes="webxr scene-viewer quick-look" ar-scale="fixed" ar-placement="floor" environment-image="neutral"
      shadow-intensity="1.2" shadow-softness="0.9" exposure="1" camera-orbit="0deg 70deg 1.5m" field-of-view="30deg">
    </model-viewer>

    <div class="glb-poster" id="glbPoster"></div>
    <div class="splat-poster" id="splatPoster"></div>
    <iframe id="splat" class="hidden" loading="lazy"
      allow=" autoplay; fullscreen; xr-spatial-tracking; camera; microphone; gyroscope; accelerometer">
    </iframe>
  </div>


  <!-- CARTELA EXCLUSIVA ESCRITORIO -->
  <aside id="infoPanel" class="desktop-only">
    <div class="info-content">
      <h2 id="infoTitleDesktop">Cristo Yacente</h2>
      <p class="info-meta">Siglo XVIII (1740) â€” Luis Salvador Carmona â€” Madera</p>
      <p class="info-desc">
        Escultura barroca en madera policromada que representa el cuerpo de Cristo tras su descendimiento.
      </p>

      <ul class="info-details">
        <li><strong>TipologÃ­a:</strong> Madera policromada</li>
        <li><strong>Material:</strong> Madera</li>
        <li><strong>Fecha:</strong> Siglo XVIII (1740)</li>
        <li><strong>Autor:</strong> Luis Salvador Carmona</li>
      </ul>
      <div class="info-actions">
        <button id="audioGuideBtn" class="info-btn-audio">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="5 3 19 12 5 21 5 3"></polygon>
          </svg>
          Escuchar audioguÃ­a
        </button>

        <a href="/" class="info-btn-visit">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
            <polyline points="16 6 12 2 8 6"></polyline>
            <line x1="12" y1="2" x2="12" y2="15"></line>
          </svg>
          Web ClÃ¡sica
        </a>
      </div>
    </div>
  </aside>

  <!-- =========================
         FABs (Audio + AR)
         ========================= -->
  <div id="fabRow" class="fab-row">
    <!-- AUDIO (izquierda) -->
    <button id="audioBtn" class="audio-fab hidden" type="button" aria-label="Reproducir audio" aria-pressed="false">
      <!-- Icono ALTAVOZ (parado) -->
      <svg class="icon-play" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M4 9v6h3l5 4V5L7 9H4z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"
          stroke-linejoin="round" />
        <path d="M15 10.5a3.5 3.5 0 010 3" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />
        <path d="M17.5 8a6 6 0 010 8" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />
      </svg>
      <!-- Icono PAUSA (reproduciendo) -->
      <svg class="icon-pause" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <rect x="6" y="5" width="4" height="14" rx="1.2" stroke="currentColor" stroke-width="1.8" />
        <rect x="14" y="5" width="4" height="14" rx="1.2" stroke="currentColor" stroke-width="1.8" />
      </svg>
    </button>

    <!-- AR (derecha) -->
    <button id="arBtn" class="ar-fab hidden" type="button" aria-label="Ver en AR">
      <!-- Spinner de carga (oculto por defecto) -->
      <svg class="ar-spinner" viewBox="0 0 24 24" fill="none" style="display: none;">
        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" stroke-linecap="round"
          stroke-dasharray="60" stroke-dashoffset="15" opacity="0.3" />
        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" stroke-linecap="round"
          stroke-dasharray="60" stroke-dashoffset="15">
          <animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="1s"
            repeatCount="indefinite" />
        </circle>
      </svg>
      <!-- Icono AR normal -->
      <svg class="ar-icon" viewBox="0 0 24 24" fill="none">
        <path d="M12 3l8.66 5v8L12 21l-8.66-5V8L12 3zM12 3v18M3.34 8L12 13l8.66-5" stroke="white" stroke-width="1.8"
          stroke-linecap="round" stroke-linejoin="round" />
      </svg>
      <span class="ar-text">Ver en AR</span>
    </button>
  </div>
  <!-- =========================
         Overlay de carga AR
         ========================= -->
  <div id="arLoading" class="ar-loading hidden" aria-hidden="true">
    <div class="spinner" aria-hidden="true"></div>
    <span id="arLoadingText">Preparando experiencia ARâ€¦</span>
  </div>

  <!-- =========================
         Cartela (Info Sheet)
         ========================= -->
  <div id="infoSheet" class="info-sheet hidden" aria-hidden="true">
    <div class="info-sheet__drag"></div>
    <button id="infoClose" class="info-sheet__close" aria-label="Cerrar">âœ•</button>
    <div class="info-sheet__content">
      <h2 id="infoTitle">Obra</h2>
      <p class="info-meta" id="infoMeta"></p>
      <p class="info-desc" id="infoDesc"></p>
    </div>
  </div>

  <!-- Link AR iOS oculto -->
  <a id="iosARLink" rel="ar" style="display:none" aria-hidden="true"></a>

  <!-- =========================
         Script principal (sin eliminar nada, solo organizado)
         ========================= -->
  <script>
    function prefetchCommonAssets() {
      const commonAssets = [
        '/assets/info.json',
        '/assets/brand/logo-museo.svg',
        '/assets/brand/isotipo.svg',
        '/index.css',
        '/sw.js'
      ];

      commonAssets.forEach(url => {
        const link = document.createElement('link');
        link.rel = 'prefetch';
        link.href = url;
        document.head.appendChild(link);
      });
    }

    window.addEventListener('load', prefetchCommonAssets);

    // ========================================
    // PRECARGA INTELIGENTE DE MODELOS 3D
    // ========================================
    function preloadModelsFor(slug) {
      if (!slug) return;

      const glbUrl = `/models/${slug}/${slug}.glb`;
      const usdzUrl = `/models/${slug}/${slug}.usdz`;

      console.log(`[Preload] Iniciando precarga de modelos para: ${slug}`);

      // Usar fetch con prioridad baja para no bloquear recursos crÃ­ticos
      fetch(glbUrl, {
        priority: 'low',
        cache: 'force-cache'
      }).then(() => {
        console.log(`[Preload] âœ… GLB precargado: ${slug}`);
      }).catch(err => {
        console.warn(`[Preload] âš ï¸ Error precargando GLB:`, err);
      });

      fetch(usdzUrl, {
        priority: 'low',
        cache: 'force-cache'
      }).then(() => {
        console.log(`[Preload] âœ… USDZ precargado: ${slug}`);
      }).catch(err => {
        console.warn(`[Preload] âš ï¸ Error precargando USDZ:`, err);
      });
    }

    // ---------------- URL Parsing (Single Source of Truth) ----------------
    function parseURL() {
      const qs = new URLSearchParams(window.location.search);
      let type = (qs.get('type') || '').toLowerCase(); // 'glb' | 'splat'
      let model = (qs.get('model') || '').toLowerCase();
      let figure = (qs.get('figure') || '').toLowerCase();

      // Support for /glb/name or /splat/name paths
      if (!type) {
        const parts = window.location.pathname.split('/').filter(Boolean);
        if (parts[0] === 'splat' && parts[1]) {
          type = 'splat';
          figure = parts[1];
        } else if (parts[0] === 'glb' && parts[1]) {
          type = 'glb';
          model = parts[1];
        } else if (parts.length === 1) {
          type = 'glb';
          model = parts[0];
        }
      }

      // Default to glb if model is present but type is not
      if (!type && (model || figure)) {
        type = figure ? 'splat' : 'glb';
      }

      // FALLBACK: Default to cristo-yacente
      if (!model && !figure) {
        type = 'glb';
        model = 'cristo-yacente';
      }

      return { type, model, figure, slug: model || figure };
    }

    const { type, model, figure, slug } = parseURL();
    window.loadedType = type;
    window.loadedModel = slug;

    console.log('ðŸŒ [URL] Detected:', { type, slug });

    document.addEventListener('DOMContentLoaded', () => {

      // ðŸš€ Iniciar precarga de modelos en background
      if (slug) {
        // Esperar 2 segundos para que carguen recursos crÃ­ticos primero
        setTimeout(() => {
          preloadModelsFor(slug);
        }, 2000);
      }

      // === ðŸŒ Selector manual de idioma ===

      // Recuperar idioma guardado o usar espaÃ±ol por defecto
      let currentLang = localStorage.getItem('museum-lang') || 'es';
      const langToggleBtn = document.getElementById('langToggleBtn');

      if (langToggleBtn) {
        langToggleBtn.textContent = currentLang.toUpperCase();

        langToggleBtn.addEventListener('click', () => {
          currentLang = currentLang === 'es' ? 'en' : 'es';
          localStorage.setItem('museum-lang', currentLang);
          langToggleBtn.textContent = currentLang.toUpperCase();
          loadInfoForSlug(slug, currentLang); // ðŸ” Recargar cartela dinÃ¡micamente
        });
      }

      // --- FunciÃ³n unificada de carga de informaciÃ³n ---
      function loadInfoForSlug(slug, lang) {
        const infoPath = `/assets/info${lang === 'en' ? '_en' : ''}.json`;
        fetch(infoPath)
          .then(res => res.json())
          .then(infoData => {
            const info = infoData[slug];
            if (!info) return;

            // MÃ³vil
            const infoTitle = document.getElementById('infoTitle');
            const infoMeta = document.getElementById('infoMeta');
            const infoDesc = document.getElementById('infoDesc');
            if (infoTitle && infoMeta && infoDesc) {
              infoTitle.textContent = info.title;
              infoMeta.textContent = `${info.year} â€” ${info.author} â€” ${info.material}`;
              infoDesc.textContent = info.desc;
            }

            // Escritorio
            const infoTitleDesktop = document.getElementById('infoTitleDesktop');
            const infoMetaDesktop = document.querySelector('#infoPanel .info-meta');
            const infoDescDesktop = document.querySelector('#infoPanel .info-desc');
            const infoDetails = document.querySelector('#infoPanel .info-details');

            if (infoTitleDesktop) infoTitleDesktop.textContent = info.title;
            if (infoMetaDesktop) infoMetaDesktop.textContent = `${info.year} â€” ${info.author} â€” ${info.material}`;
            if (infoDescDesktop) infoDescDesktop.textContent = info.desc;
            if (infoDetails) {
              infoDetails.innerHTML = `
          <li><strong>${lang === 'en' ? 'Typology' : 'TipologÃ­a'}:</strong> ${info.typology || 'â€”'}</li>
          <li><strong>${lang === 'en' ? 'Material' : 'Material'}:</strong> ${info.material || 'â€”'}</li>
          <li><strong>${lang === 'en' ? 'Date' : 'Fecha'}:</strong> ${info.year || 'â€”'}</li>
          <li><strong>${lang === 'en' ? 'Author' : 'Autor'}:</strong> ${info.author || 'â€”'}</li>
        `;
            }

            console.log(`[Museo] Idioma: ${lang.toUpperCase()} â€” Datos cargados de ${infoPath}`);
          })
          .catch(err => console.error('[Museo] Error cargando info.json:', err));
      }

      // Cargar idioma inicial al abrir la pÃ¡gina
      loadInfoForSlug(slug, currentLang);


      // === ðŸŽ§ SINCRONIZAR CARTELA Y AUDIO (VERSIÃ“N ESCRITORIO) ===

      fetch('/assets/info.json')
        .then(res => res.json())
        .then(infoData => {
          const info = infoData[slug];
          if (!info) {
            console.warn(`[Museo] No se encontrÃ³ info para "${slug}"`);
            return;
          }

          // ðŸŸ© Actualizar cartela mÃ³vil (ya existente)
          const infoTitle = document.getElementById('infoTitle');
          const infoMeta = document.getElementById('infoMeta');
          const infoDesc = document.getElementById('infoDesc');
          if (infoTitle && infoMeta && infoDesc) {
            infoTitle.textContent = info.title;
            infoMeta.textContent = `${info.year} â€” ${info.author} â€” ${info.material}`;
            infoDesc.textContent = info.desc;
          }

          // ðŸŸ© Actualizar cartela escritorio
          const infoTitleDesktop = document.getElementById('infoTitleDesktop');
          const infoMetaDesktop = document.querySelector('#infoPanel .info-meta');
          const infoDescDesktop = document.querySelector('#infoPanel .info-desc');
          const infoDetails = document.querySelector('#infoPanel .info-details');

          if (infoTitleDesktop) infoTitleDesktop.textContent = info.title;
          if (infoMetaDesktop) infoMetaDesktop.textContent = `${info.year} â€” ${info.author} â€” ${info.material}`;
          if (infoDescDesktop) infoDescDesktop.textContent = info.desc;

          // ðŸŸ¨ Actualizar lista de detalles
          if (infoDetails) {
            infoDetails.innerHTML = `
        <li><strong>TipologÃ­a:</strong> ${info.typology || 'â€”'}</li>
        <li><strong>Material:</strong> ${info.material || 'â€”'}</li>
        <li><strong>Fecha:</strong> ${info.year || 'â€”'}</li>
        <li><strong>Autor:</strong> ${info.author || 'â€”'}</li>
      `;
          }

        })
        .catch(err => console.error('[Museo] Error cargando info.json:', err));


      // Estado persistente de la cartela por pieza
      const sheetKeyFor = (s) => `sheet:${s}`;

      // ---------------- Elementos del DOM ----------------
      const fabRow = document.getElementById('fabRow');
      const mv = document.getElementById('mv');
      const splat = document.getElementById('splat');
      const skel = document.getElementById('skel');
      const msg = document.getElementById('msg');
      const arBtn = document.getElementById('arBtn');
      const topBar = document.getElementById('topBar');
      const pieceTitle = document.getElementById('pieceTitle');
      const infoBtn = document.getElementById('infoBtn');
      const sheet = document.getElementById('infoSheet');
      const sheetClose = document.getElementById('infoClose');
      const infoTitle = document.getElementById('infoTitle');
      const infoMeta = document.getElementById('infoMeta');
      const infoDesc = document.getElementById('infoDesc');
      const audioBtn = document.getElementById('audioBtn');

      // === Desktop mode toggle ===
      const mqDesk = window.matchMedia('(min-width: 1025px)');
      function applyDesktopClass() {
        document.body.classList.toggle('is-desktop', mqDesk.matches);
        // En desktop: cartela siempre visible y sin botÃ³n cerrar
        if (mqDesk.matches) {
          // mostrar cartela si hay slug
          try { sheet.classList.remove('hidden'); sheet.setAttribute('aria-hidden', 'false'); } catch { }
        }
      }
      mqDesk.addEventListener?.('change', applyDesktopClass);
      applyDesktopClass();

      // === Cheatsheet: H para mostrar/ocultar (solo desktop) ===
      const kbd = document.getElementById('kbdHelp');
      window.addEventListener('keydown', (e) => {
        if (!document.body.classList.contains('is-desktop')) return;
        if (e.key.toLowerCase() === 'h') {
          kbd.classList.toggle('hidden');
          kbd.setAttribute('aria-hidden', kbd.classList.contains('hidden') ? 'true' : 'false');
        }
      });


      if (infoBtn) {
        infoBtn.setAttribute('aria-controls', 'infoSheet');
        infoBtn.setAttribute('aria-expanded', 'false');
      }

      // Accesibilidad: anuncia el progreso del loader
      const loaderProgressEl = document.getElementById('loaderProgress');
      if (loaderProgressEl) {
        loaderProgressEl.setAttribute('role', 'status');
        loaderProgressEl.setAttribute('aria-live', 'polite');
        loaderProgressEl.setAttribute('aria-atomic', 'true');
      }

      // Wake Lock para evitar que se apague la pantalla mientras se usa la app
      let wakeLock = null;
      async function requestWakeLock() {
        try {
          if ('wakeLock' in navigator && !wakeLock) {
            wakeLock = await navigator.wakeLock.request('screen');
            wakeLock.addEventListener('release', () => {
              wakeLock = null;
            });
          }
        } catch (e) {
          // Algunos mÃ³viles lo bloquean; sin drama
          console.debug('WakeLock no disponible:', e?.message || e);
        }
      }
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
          requestWakeLock();
        } else if (wakeLock) {
          try {
            wakeLock.release();
          } catch { }
          wakeLock = null;
        }
      });
      // Primer intento en cuanto cargue
      requestWakeLock();

      // ---------------- Rutas y helpers ----------------
      const glbUrl = (name) => `/models/${name}/${name}.glb`;
      const usdzUrl = (name) => `/models/${name}/${name}.usdz`;
      const splatUrl = (name) => `/splat/${name}/viewer.html?noui=1`;

      // === Firma efÃ­mera de URLs (token 60s) ===
      const signedCache = new Map();

      async function signPath(path) {
        // Devuelve URL absoluta firmada o lanza error
        const r = await fetch(`/api/sign?f=${encodeURIComponent(path)}`, {
          cache: 'no-store',
          credentials: 'omit'
        });
        if (!r.ok) throw new Error('sign failed');
        const { url } = await r.json();
        return url;
      }

      async function signedOrPlain(path) {
        try {
          if (signedCache.has(path)) return signedCache.get(path);
          const url = await signPath(path);
          signedCache.set(path, url);
          return url;
        } catch {
          // Fallback si algo falla (no bloquea la UX)
          return path;
        }
      }


      async function exists(url) {
        try {
          const r = await fetch(url, {
            method: 'HEAD',
            cache: 'force-cache',
            priority: 'low',
            keepalive: true
          });
          return r.ok;
        } catch {
          return false;
        }
      }

      // Helpers de plataforma
      const isIOS =
        /iPad|iPhone|iPod/i.test(navigator.userAgent) ||
        (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      const isAndroid = /Android/.test(navigator.userAgent);

      // Helper para resetear listeners de un botÃ³n sin cambiar su HTML ni clases
      function resetClick(el) {
        const clone = el.cloneNode(true);
        el.replaceWith(clone);
        return clone; // el nuevo nodo sin listeners
      }

      // Helpers de visibilidad
      function show(el) {
        if (el) el.classList.remove('hidden');
      }
      function hide(el) {
        if (el) el.classList.add('hidden');
      }

      // ðŸŸ¢ Haptics robusto + fallback visual
      function supportsVibrate() {
        return typeof navigator !== 'undefined' && typeof navigator.vibrate === 'function';
      }
      function addHapticFeedback(selector, pattern = [18]) {
        const btn = document.querySelector(selector);
        if (!btn) return;

        // Fallback visual (escala rÃ¡pida) para iOS/desktop
        const pulse = () => {
          btn.classList.add('tap-pulse');
          setTimeout(() => btn.classList.remove('tap-pulse'), 120);
        };

        const onDown = () => {
          let didVibrate = false;
          try {
            if (supportsVibrate()) {
              // En algunos Android un solo valor pequeÃ±o se ignora: patrÃ³n corto ayuda
              didVibrate = navigator.vibrate(pattern);
            }
          } catch { }
          if (!didVibrate) pulse();
        };

        // feedback inmediato
        btn.addEventListener('pointerdown', onDown);
      }
      addHapticFeedback('#infoBtn', [14]);
      addHapticFeedback('#infoClose', [14]);
      addHapticFeedback('#arBtn', [20]);
      addHapticFeedback('#audioBtn', [12, 8]);
      addHapticFeedback('#homeBtn', [12]);
      addHapticFeedback('#homeBtn', [12]);


      console.debug('[haptics] vibrate supported?', supportsVibrate());

      // Toast reutilizable (mensaje flotante)
      function showToast(message = 'Pulsa de nuevo para habilitar el audio', ms = 1800) {
        let t = document.querySelector('.toast');
        if (!t) {
          t = document.createElement('div');
          t.className = 'toast';
          document.body.appendChild(t);
        }
        t.textContent = message;
        t.classList.add('show');
        window.clearTimeout(showToast._timer);
        showToast._timer = window.setTimeout(() => t.classList.remove('show'), ms);
      }

      // Mensaje de error con CTA de reintento
      function showErrorAndRetry(kind, name, retryFn) {
        const cta = document.createElement('div');
        cta.style.cssText = 'margin-top:12px; display:flex; gap:8px; justify-content:center;';
        const btnRetry = document.createElement('button');
        btnRetry.textContent = 'Reintentar';
        btnRetry.className = 'info-btn';
        btnRetry.style.minWidth = 'auto';
        btnRetry.onclick = () => {
          const msg = document.getElementById('msg');
          if (msg) msg.classList.add('hidden');
          retryFn?.();
        };

        const msg = document.getElementById('msg');
        if (msg) {
          msg.innerHTML = `
              <div>
                <b>No se pudo cargar la pieza</b><br/><br/>
                Tipo: <code>${kind}</code> Â· Id: <code>${name}</code><br/>
                Puede ser tu conexiÃ³n o un archivo temporalmente no disponible.
              </div>`;
          msg.appendChild(cta);
          cta.appendChild(btnRetry);
          msg.classList.remove('hidden');
        }

        showToast('Error de carga. Pulsa â€œReintentarâ€.', 2200);
      }

      // Habilita/Deshabilita el botÃ³n AR visual y funcionalmente
      function setArEnabled(enabled) {
        const btn = document.getElementById('arBtn');
        if (!btn) return;
        if (enabled) {
          btn.removeAttribute('disabled');
          btn.classList.remove('is-disabled');
        } else {
          btn.setAttribute('disabled', 'true');
          btn.classList.add('is-disabled');
        }
      }

      // --- Standalone detector (A2HS) ---
      function isStandalone() {
        const iosStandalone = ('standalone' in navigator) && navigator.standalone;
        const pwaStandalone = window.matchMedia && window.matchMedia('(display-mode: standalone)').matches;
        return iosStandalone || pwaStandalone;
      }

      // --- Watchdog de progreso de <model-viewer> ---
      function startProgressWatchdog(mvEl, { timeoutMs = 8000, onStall } = {}) {
        let progressed = false;
        const onProg = (e) => {
          const p = e?.detail?.totalProgress ?? 0;
          if (p > 0) progressed = true;
        };
        mvEl.addEventListener('progress', onProg, { passive: true });
        const timer = setTimeout(() => {
          mvEl.removeEventListener('progress', onProg);
          if (!progressed) onStall?.();
        }, timeoutMs);
        return () => { clearTimeout(timer); mvEl.removeEventListener('progress', onProg); };
      }


      // ---------------- Audio por figura (botÃ³n siempre visible + cleanup) ----------------
      let audio = null;
      let audioCleanup = () => { };
      async function setupAudioFor(id) {
        // Mapeo de archivos de audio especÃ­ficos que no coinciden con el slug o tienen otra extensiÃ³n
        const audioMap = {
          'jesus-en-la-cruz': 'Cristo_de_papel.mp3',
          'bargueno-relicario': 'bargueÃ±o_relicario.mp3',
          'cuadro-la-elevacion-de-la-cruz': 'cuadro_Elevacion_de_la_cruz.mp3',
          'virgen-asuncion': 'virgen-asuncion.mp3',
          'casulla-santa-ana': 'Casulla.mp3',
          'goya-uno': 'Cuadro_Goya_Santa_Lutgarda_.mp3',
          'goya-dos': 'Cuadro_Goya_El_transito_de_san_Jose.mp3',
          'goya-tres': 'Cuadro_Goya_SanBernardo.mp3',
          'bayeu-uno': 'Cuadro_Bayeu_Santa_Escolastica.mp3',
          'bayeu-dos': 'Cuadro_Bayeu_Inmaculada.mp3',
          'bayeu-tres': 'Cuadro_Bayeu_SanBenito.mp3',
          'virgen-de-mena': 'Dolorosa.mp3',
          'virgen-romanica': 'Virgen_Romanica.mp3',
          'novisimos': 'Novisimos.mp3',
          'reliquia-dorada': 'custodia-trofeo.mp3'
        };

        const fileName = audioMap[id] || `${id}.mp3`;
        const audioPath = `/assets/audio/${fileName}`;
        const audioBtn = document.getElementById('audioBtn');
        const audioGuideBtn = document.getElementById('audioGuideBtn');

        // Detener y limpiar audios anteriores
        if (audio) {
          try { audio.pause(); } catch { }
          audio = null;
        }

        try { audioCleanup(); } catch { }

        // Crear audio nuevo
        console.log(`[Audio] Intentando cargar: ${audioPath}`);
        audio = new Audio(audioPath);
        audio.loop = true;
        audio.preload = 'auto';

        // FunciÃ³n para alternar play/pause y actualizar botones varios
        const toggleAudio = async (btn) => {
          if (!audio) return;
          if (audio.paused) {
            try {
              await audio.play();
              btn.classList.add('is-playing');
              if (btn === audioGuideBtn) {
                btn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="6" y="5" width="4" height="14" rx="1.2"></rect>
              <rect x="14" y="5" width="4" height="14" rx="1.2"></rect>
            </svg>
            Pausar audioguÃ­a
          `;
              }
            } catch (err) {
              console.warn('Audio bloqueado o no disponible:', err);
            }
          } else {
            audio.pause();
            btn.classList.remove('is-playing');
            if (btn === audioGuideBtn) {
              btn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="5 3 19 12 5 21 5 3"></polygon>
          </svg>
          Escuchar audioguÃ­a
        `;
            }
          }
        };

        // Listeners para ambos botones
        if (audioBtn) {
          audioBtn.classList.remove('hidden');
          audioBtn.onclick = () => toggleAudio(audioBtn);
        }
        if (audioGuideBtn) {
          audioGuideBtn.onclick = () => toggleAudio(audioGuideBtn);
        }

        // Limpieza
        audioCleanup = () => {
          try { audio.pause(); } catch { }
          audio = null;
        };
      }

      // ---------------- AR helpers ----------------
      // ========================================
      // VARIABLES DE COOLDOWN AR
      // ========================================
      const AR_COOLDOWN_MS = 7000; // 7 segundos de cooldown
      let lastARClickTime = 0; // Timestamp del Ãºltimo click en AR

      function openARFor(name) {
        const usdz = usdzUrl(name);
        const glb = glbUrl(name);
        const titleEl = document.getElementById('infoTitle');
        const arTitle = encodeURIComponent((titleEl?.textContent || name).trim());

        if (isIOS) {
          window.location.href = usdz;
          return;
        }
        if (isAndroid) {
          const file = new URL(glb, location.origin).toString();
          const intent = `intent://arvr.google.com/scene-viewer/1.0?file=${encodeURIComponent(
            file
          )}&mode=ar_preferred&title=${arTitle}#Intent;scheme=https;package=com.google.android.googlequicksearchbox;action=android.intent.action.VIEW;end;`;
          window.location.href = intent.replace(";end;", ";S.browser_fallback_url=" + encodeURIComponent(file) + ";end;");
        }
      }

      function openQuickLookSync(slug) {
        try {
          const link = document.getElementById('iosARLink');
          if (!link) return false;
          const ts = Date.now(); // cache-buster (cada click es "nuevo")
          link.setAttribute('href', preSigned?.usdz || usdzUrl(slug));
          link.click(); // sÃ­ncrono, en la misma pila del gesto
          return true;
        } catch {
          return false;
        }
      }

      // ========================================
      // MEJORAS DE FEEDBACK AR - INSTRUCCIONES
      // ========================================

      /*
      INSTRUCCIONES PARA IMPLEMENTAR:
      
      1. Busca en index.html las lÃ­neas 782-788 que contienen:
         
            // Overlay "Abriendo ARâ€¦."
            function showARLoading() {
              const el = document.getElementById('arLoading');
              if (!el) return;
              el.classList.remove('hidden');
              requestAnimationFrame(() => el.classList.add('visible'));
            }
      
      2. ReemplÃ¡zalas con el siguiente cÃ³digo:
      */

      // ========================================
      // CÃ“DIGO NUEVO PARA showARLoading
      // ========================================

      // Overlay "Abriendo ARâ€¦." con feedback instantÃ¡neo
      let arLoadingTimeout = null;

      function showARLoading() {
        console.log('ðŸ”¥ showARLoading() LLAMADO');

        const el = document.getElementById('arLoading');
        const btn = document.getElementById('arBtn');
        const textEl = document.getElementById('arLoadingText');

        if (!el) {
          console.error('âŒ NO SE ENCONTRÃ“ #arLoading');
          return;
        }

        console.log('âœ… Mostrando overlay AR');

        // ðŸ”¥ FEEDBACK INSTANTÃNEO: Cambiar botÃ³n a estado loading
        if (btn) {
          btn.classList.add('is-loading');
          btn.setAttribute('disabled', 'true');
          const arText = btn.querySelector('.ar-text');
          if (arText) arText.textContent = 'Preparandoâ€¦';
          try {
            if (navigator.vibrate) navigator.vibrate(20);
          } catch { }
        }

        // Mensaje especÃ­fico por plataforma
        if (textEl) {
          if (isIOS) {
            textEl.textContent = 'Cargando Realidad Aumentada...';
          } else if (isAndroid) {
            textEl.textContent = 'Cargando Realidad Aumentada...';
          } else {
            textEl.textContent = 'Cargando Realidad Aumentada...';
          }
        }

        // ðŸš¨ FORZAR OVERLAY A APARECER Y MANTENERSE
        el.classList.remove('hidden');
        el.style.display = 'flex';
        el.style.position = 'fixed';
        el.style.inset = '0';
        el.style.zIndex = '99999';
        el.style.background = 'rgba(10, 12, 16, 0.95)';
        el.style.visibility = 'visible';
        el.style.opacity = '1';
        el.classList.add('visible');

        console.log('âœ… Overlay visible con opacity 1');

        // Timeout de seguridad: 60s para conexiones MUY lentas
        clearTimeout(arLoadingTimeout);
        arLoadingTimeout = setTimeout(() => {
          console.warn('â±ï¸ TIMEOUT: 60s - ocultando overlay por timeout');
          hideARLoading();
        }, 60000); // 60 segundos
      }

      // ========================================
      // FIN DEL CÃ“DIGO
      // ========================================

      /*
      NOTA: La funciÃ³n hideARLoading() ya estÃ¡ correctamente actualizada en las lÃ­neas 789-809.
      No necesitas modificarla.
      
      RESULTADO ESPERADO:
      - Al tocar el botÃ³n AR, cambiarÃ¡ INMEDIATAMENTE a color naranja
      - MostrarÃ¡ un spinner girando
      - El texto cambiarÃ¡ a "Preparandoâ€¦"
      - VibrarÃ¡ el dispositivo (en Android)
      - El overlay aparecerÃ¡ con mensaje especÃ­fico por plataforma
      - Si tarda mÃ¡s de 10s, se ocultarÃ¡ automÃ¡ticamente
      */



      function hideARLoading() {
        const el = document.getElementById('arLoading');
        const btn = document.getElementById('arBtn');

        if (!el) return;

        // Limpiar timeout
        clearTimeout(arLoadingTimeout);

        // Restaurar botÃ³n a estado normal
        if (btn) {
          btn.classList.remove('is-loading');
          btn.removeAttribute('disabled');

          const arText = btn.querySelector('.ar-text');
          if (arText) arText.textContent = 'Ver en AR';
        }

        el.classList.remove('visible');
        setTimeout(() => el.classList.add('hidden'), 250);
      }
      // ========================================
      // SOLUCIÃ“N FINAL PARA EL OVERLAY AR
      // ========================================

      /**
       * PROBLEMA IDENTIFICADO:
       * El overlay SÃ aparece pero desaparece inmediatamente (flashazo)
       * porque el evento 'visibilitychange' lo oculta cuando cambias a la app de AR.
       * 
       * SOLUCIÃ“N:
       * Comentar/eliminar el listener de visibilitychange
       */

      // ========================================
      // PASO 1: Busca las lÃ­neas 906-915 en index.html
      // ========================================
      // DeberÃ­as ver esto:

      // Solo ocultar overlay cuando el usuario vuelve a la pÃ¡gina
      // (esto permite que el overlay se mantenga mientras AR se abre)
      document.addEventListener('visibilitychange', () => {
        // Esperar un poco para asegurar que AR realmente se abriÃ³
        if (!document.hidden) {
          setTimeout(() => {
            hideARLoading();
          }, 500);
        }
      });

      // ========================================
      // PASO 2: REEMPLÃZALO con esto (comentado):
      // ========================================

      // âš ï¸ DESHABILITADO: No ocultar automÃ¡ticamente el overlay
      // El overlay debe mantenerse visible hasta que AR cargue completamente
      // Solo se ocultarÃ¡ por timeout (60s)
      /*
      document.addEventListener('visibilitychange', () => {
        if (!document.hidden) {
          setTimeout(() => {
            hideARLoading();
          }, 500);
        }
      });
      */

      // ---------------- Info JSON ----------------
      async function loadInfoDataOrFallback(current, lang = "es") {
        try {
          const file = lang === "en" ? "/assets/info_en.json" : "/assets/info.json";
          const res = await fetch(file, { cache: "no-store" });
          if (!res.ok) throw new Error("no info.json");
          const json = await res.json();
          console.log(`âœ… Datos cargados (${lang}):`, json);
          return json || current;
        } catch (e) {
          console.warn("âš ï¸ Error cargando info.json:", e);
          return current;
        }
      }

      // ---------------- Cartela ----------------
      function showHelp() {
        skel.classList.add('hidden');
        msg.classList.remove('hidden');
        msg.innerHTML = `
            <div>
              <b>Falta parÃ¡metro en la URL.</b><br/><br/>
              Usa ejemplos:<br/>
              <code>?type=glb&model=cristo-yacente</code><br/>
              <code>?type=splat&figure=calvo-anillo</code>
            </div>`;
      }

      let infoData = {
        'cristo-yacente': {
          title: 'Cristo Yacente',
          meta: 's. XVII Â· Autor/a desconocido/a',
          desc: 'DescripciÃ³n pendiente.'
        },
        'virgen-romanica': {
          title: 'Virgen RomÃ¡nica',
          meta: 's. XII Â· Talla policromada',
          desc: 'DescripciÃ³n pendiente.'
        },
        'san-jose-con-el-nino': {
          title: 'San JosÃ© con el NiÃ±o',
          meta: 's. XVIII',
          desc: 'DescripciÃ³n pendiente.'
        },
        'jesus-en-la-cruz': {
          title: 'Cristo en la Cruz',
          meta: 's. XVII',
          desc: 'DescripciÃ³n pendiente.'
        }
      };

      // CÃ¡mara por figura
      const cameraSettings = {
        'cristo-yacente': {
          orbit: '53deg 43deg 100%',
          fov: '22deg',
          target: '0m 2m 0m',
          minRadius: '1m',
          maxRadius: '2.8m',
          minFov: '22deg',
          maxFov: '30deg'
        },
        'jesus-en-la-cruz': {
          orbit: '-88deg 71deg 100%',
          fov: '27deg',
          target: '-1.91m -0.14m 0.34m',
          minRadius: '3m',
          maxRadius: '14.8m',
          minFov: '22deg',
          maxFov: '77deg'
        },
        'san-jose-con-el-nino': {
          orbit: '133deg 92deg 139%',
          fov: '37deg',
          target: '-0.27m 2.74m -0.03m',
          minRadius: '2.7m',
          maxRadius: '6.6m',
          minFov: '22deg',
          maxFov: '45deg'
        },
        'san-bernardo-con-la-virgen': {
          orbit: '-4deg 80deg 100%',
          fov: '47deg',
          target: '0.07m 1.53m 2m',
          minRadius: '2.1m',
          maxRadius: '4.1m',
          minFov: '22deg',
          maxFov: '47deg'
        },
        'virgen-asuncion': {
          orbit: '-81deg 70deg 100%',
          fov: '45deg',
          target: '-0.05m 1.8m 0.05m',
          minRadius: '2.1m',
          maxRadius: '5.5m',
          minFov: '20deg',
          maxFov: '45deg'
        },
        'virgen-de-mena': {
          orbit: '-89deg 70deg 100%',
          fov: '30deg',
          target: '0.09m 0.95m 0.02m',
          minRadius: '1.6m',
          maxRadius: '5.5m',
          minFov: '22deg',
          maxFov: '30deg'
        },
        'virgen-romanica': {
          orbit: '-180deg 70deg 100%',
          fov: '45deg',
          target: '-0.32m 2.25m 2m',
          minRadius: '3.9m',
          maxRadius: '8.3m',
          minFov: '20deg',
          maxFov: '45deg'
        },
        'ecce-homo': {
          orbit: '133deg 70deg 100%',
          fov: '45deg',
          target: '0.41m 1.5m -0.37m',
          minRadius: '3.3m',
          maxRadius: '10m',
          minFov: '20deg',
          maxFov: '45deg'
        },
        'reliquia-dorada': {
          orbit: '1deg 89deg 100%',
          fov: '20deg',
          target: '0m 0m 0m',
          minRadius: '5.4m',
          maxRadius: '8.3m',
          minFov: '20deg',
          maxFov: '56deg'
        },
        'bargueno-relicario': {
          orbit: '-180deg 70deg 100%',
          fov: '64deg',
          target: '-0.08m 0.97m 0.69m',
          minRadius: '3m',
          maxRadius: '8.8m',
          minFov: '20deg',
          maxFov: '64deg'
        },
        'cristo-atado-a-la-columna': {
          orbit: '-2deg 70deg 100%',
          fov: '50deg',
          target: '0.11m 1.31m -0.64m',
          minRadius: '1.9m',
          maxRadius: '4.9m',
          minFov: '22deg',
          maxFov: '50deg'
        },
        'jesus-atado-a-la-columna': {
          orbit: '-2deg 70deg 100%',
          fov: '50deg',
          target: '0.11m 1.31m -0.64m',
          minRadius: '1.9m',
          maxRadius: '4.9m',
          minFov: '22deg',
          maxFov: '50deg'
        },
        'tapiz': {
          orbit: '92deg 90deg 100%',
          fov: '57deg',
          target: '-0.03m -0.02m -0.07m',
          minRadius: '1m',
          maxRadius: '3.7m',
          minFov: '25deg',
          maxFov: '57deg'
        },
        'casulla-santa-ana': {
          orbit: '-92deg 70deg 100%',
          fov: '45deg',
          target: '0.17m 1.71m -0.11m',
          minRadius: '5.6m',
          maxRadius: '17.9m',
          minFov: '25deg',
          maxFov: '45deg'
        },
        'novisimos': {
          orbit: '-87deg 89deg 100%',
          fov: '51deg',
          target: '0.02m 0m 0.05m',
          minRadius: '1m',
          maxRadius: '1.1m',
          minFov: '22deg',
          maxFov: '51deg'
        },
        'goya-uno': {
          orbit: '3deg 85deg 100%',
          fov: '60deg',
          target: '0.09m 0.84m -0.15m',
          minRadius: '1.8m',
          maxRadius: '3.5m',
          minFov: '10deg',
          maxFov: '60deg'
        },
        'goya-dos': {
          orbit: '-91deg 88deg 100%',
          fov: '59deg',
          target: '-2m 2.01m -0.24m',
          minRadius: '1.6m',
          maxRadius: '8.4m',
          minFov: '10deg',
          maxFov: '60deg'
        },
        'goya-tres': {
          orbit: '-92deg 89deg 100%',
          fov: '60deg',
          target: '-0.37m 1.5m -0.13m',
          minRadius: '4.6m',
          maxRadius: '10.4m',
          minFov: '10deg',
          maxFov: '60deg'
        },
        'bayeu-uno': {
          orbit: '-91deg 89deg 100%',
          fov: '60deg',
          target: '0m 1.77m -0.05m',
          minRadius: '5.2m',
          maxRadius: '12.3m',
          minFov: '10deg',
          maxFov: '60deg'
        },
        'bayeu-dos': {
          orbit: '-89deg 88deg 100%',
          fov: '60deg',
          target: '0m 1.48m 0m',
          minRadius: '6.7m',
          maxRadius: '11.5m',
          minFov: '10deg',
          maxFov: '60deg'
        },
        'bayeu-tres': {
          orbit: '-89deg 91deg 100%',
          fov: '60deg',
          target: '0.49m 0.7m 0.17m',
          minRadius: '3m',
          maxRadius: '3.4m',
          minFov: '10deg',
          maxFov: '60deg'
        },
        'cuadro-la-elevacion-de-la-cruz': {
          orbit: '-86deg 89deg 100%',
          fov: '76deg',
          target: '0.13m -1m 0.57m',
          minRadius: '20m',
          maxRadius: '25.2m',
          minFov: '10deg',
          maxFov: '76deg'
        }
      };

      window.cameraSettings = cameraSettings;

      function buildMeta(d) {
        if (!d) return '';
        if (d.author || d.year || d.material) {
          const parts = [];
          if (d.year) parts.push(d.year);
          if (d.author) parts.push(d.author);
          if (d.material) parts.push(d.material);
          return parts.filter(Boolean).join(' Â· ');
        }
        return d.meta || '';
      }

      function renderInfo(s) {
        const d = infoData[s] || {};
        const nice = (x) => (x || s || '').replace(/-/g, ' ').trim();

        if (topBar && s) {
          topBar.classList.remove('hidden');
          pieceTitle.textContent = d.title || nice(s);
        }
        infoTitle.textContent = d.title || nice(s);
        infoMeta.textContent = buildMeta(d);

        const desc = d.desc || '';
        const extras = [];
        if (d.typology) extras.push(`<div><strong>TipologÃ­a:</strong> ${d.typology}</div>`);
        if (d.material) extras.push(`<div><strong>Material:</strong> ${d.material}</div>`);
        if (d.technique) extras.push(`<div><strong>TÃ©cnica:</strong> ${d.technique}</div>`);
        if (d.dimensions) extras.push(`<div><strong>Dimensiones:</strong> ${d.dimensions}</div>`);
        if (d.year) extras.push(`<div><strong>Fecha:</strong> ${d.year}</div>`);
        if (d.author) extras.push(`<div><strong>Autor:</strong> ${d.author}</div>`);

        const extrasHtml = extras.length ? `<div class="info-extra">${extras.join('')}</div>` : '';
        infoDesc.innerHTML = [desc, extrasHtml].filter(Boolean).join('');

        // Actualizar <title> del documento
        try {
          const txt = (infoTitle?.textContent || s || 'Museo Virtual').trim();
          if (txt) document.title = `${txt} Â· Museo Virtual San JoaquÃ­n y Santa Ana`;
        } catch { }
      }

      // Panel/cartela UI
      function openSheet() {
        renderInfo(slug);
        sheet.classList.remove('hidden');
        sheet.setAttribute('aria-hidden', 'false');
        document.body.classList.add('sheet-open');

        if (infoBtn) {
          infoBtn.setAttribute('aria-expanded', 'true');
          infoBtn.setAttribute('aria-label', 'Ocultar informaciÃ³n');
        }

        if (slug) {
          try {
            localStorage.setItem(sheetKeyFor(slug), 'open');
          } catch { }
        }
      }

      function closeSheet() {
        sheet.classList.add('hidden');
        sheet.setAttribute('aria-hidden', 'true');
        document.body.classList.remove('sheet-open');

        if (infoBtn) {
          infoBtn.setAttribute('aria-expanded', 'false');
          infoBtn.setAttribute('aria-label', 'Mostrar informaciÃ³n');
        }

        if (slug) {
          try {
            localStorage.setItem(sheetKeyFor(slug), 'closed');
          } catch { }
        }
      }

      function toggleSheet() {
        const hidden = sheet.classList.contains('hidden');
        hidden ? openSheet() : closeSheet();
      }

      if (infoBtn) infoBtn.addEventListener('click', toggleSheet);
      sheetClose.addEventListener('click', closeSheet);
      sheet.addEventListener('click', (e) => {
        if (e.target === sheet) closeSheet();
      });

      window.addEventListener('keydown', (e) => {
        // Ignorar si escribes dentro de inputs/textarea/contenteditable
        const t = e.target;
        const typing =
          t &&
          (t.tagName === 'INPUT' || t.tagName === 'TEXTAREA' || t.isContentEditable);
        if (typing) return;

        if (e.key === 'Escape') {
          closeSheet();
        } else if (e.key.toLowerCase() === 'i') {
          toggleSheet();
        }
      });

      /* === Desktop mode: barra lateral fija + sin AR === */
      const DESKTOP_MQ = window.matchMedia('(min-width: 1024px)');
      function applyDesktopMode() {
        const isDesktop = DESKTOP_MQ.matches && !/Android|iPhone|iPad/i.test(navigator.userAgent);
        document.body.classList.toggle('is-desktop', isDesktop);

        // En desktop: cartela siempre visible como lateral
        const sheet = document.getElementById('infoSheet');
        const topBar = document.getElementById('topBar');
        if (isDesktop) {
          // Asegura topbar y cartela visibles
          topBar?.classList.remove('hidden');
          sheet?.classList.remove('hidden');
          sheet?.setAttribute('aria-hidden', 'false');
          document.body.classList.add('sheet-open');

          // Oculta AR (aunque el CSS ya lo esconde)
          const arBtn = document.getElementById('arBtn');
          if (arBtn) {
            arBtn.setAttribute('disabled', 'true');
            arBtn.classList.add('is-disabled', 'hidden');
          }
        } else {
          // Vuelve a comportamiento mÃ³vil (cartela controlada por el botÃ³n)
          document.body.classList.remove('sheet-open');
          // no forzamos hidden aquÃ­: de eso se encarga tu lÃ³gica actual
        }
      }
      DESKTOP_MQ.addEventListener?.('change', applyDesktopMode);
      applyDesktopMode();

      // ðŸ‘‰ Forzar reglas de escritorio desde JS (defensa extra por si algÃºn handler intenta cerrar)
      const IS_DESKTOP = window.matchMedia('(min-width: 1024px)').matches;
      if (IS_DESKTOP) {
        try {
          // Forzar cartela abierta
          const sheet = document.getElementById('infoSheet');
          const infoBtn = document.getElementById('infoBtn');
          const sheetClose = document.getElementById('infoClose');

          if (sheet) {
            sheet.classList.remove('hidden');
            sheet.setAttribute('aria-hidden', 'false');
            document.body.classList.add('sheet-open');
          }
          // Ocultar controles de abrir/cerrar
          if (infoBtn) infoBtn.style.display = 'none';
          if (sheetClose) sheetClose.style.display = 'none';

          // Neutralizar posibles cierres por teclado (Esc) u otros
          window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
              e.stopImmediatePropagation();
              e.preventDefault();
            }
          }, true);
        } catch { }
      }
      // ---------------- InicializaciÃ³n ----------------
// ========================================
// LOGICA UNIFICADA DE VISOR (v3.0 - SIMPLIFICADA)
// ========================================
(async function initViewer() {
    // 1. Parsing de URL
    const qs = new URLSearchParams(window.location.search);
    let type = (qs.get('type') || '').toLowerCase();
    let model = (qs.get('model') || '').toLowerCase();
    let figure = (qs.get('figure') || '').toLowerCase();

    // Soporte para rutas limpias /glb/slug o /splat/slug
    if (!type) {
        const parts = window.location.pathname.split('/').filter(Boolean);
        if (parts[0] === 'splat' && parts[1]) { type = 'splat'; figure = parts[1]; }
        else if (parts[0] === 'glb' && parts[1]) { type = 'glb'; model = parts[1]; }
        else if (parts.length === 1) { type = 'glb'; model = parts[0]; }
    }

    // Defaults
    if (!type && (model || figure)) type = figure ? 'splat' : 'glb';
    if (!model && !figure) { type = 'glb'; model = 'cristo-yacente'; }
    const slug = model || figure;

    console.log('ðŸŒ [Visor] Iniciando:', { type, slug });

    // 2. Elementos DOM
    const mv = document.getElementById('mv');
    const splat = document.getElementById('splat');
    const skel = document.getElementById('skel');
    const msg = document.getElementById('msg');
    const infoPanel = document.getElementById('infoPanel');

    // 3. Helpers de URL (DIRECTAS, SIN FIRMA)
    const glbUrl = (name) => `/models/${name}/${name}.glb`;
    const usdzUrl = (name) => `/models/${name}/${name}.usdz`;
    const posterUrl = (name) => `/assets/posters/desktop/${name}.webp`; // Preferir desktop para calidad

    // 4. ConfiguraciÃ³n de IluminaciÃ³n (CRÃTICO PARA EVITAR MODELOS BLANCOS)
    const HDR_URL = '/assets/hdr/studio_small_09_2k.hdr';

    const applyLighting = (el) => {
        // Forzar entorno neutro o HDR especÃ­fico
        el.setAttribute('environment-image', HDR_URL);
        el.setAttribute('skybox-image', ''); // Sin fondo visible
        el.exposure = 1.0;
        el.shadowIntensity = 1.5;
        el.shadowSoftness = 0.8;
    };

    // 5. LÃ³gica de Carga GLB
    if (type === 'glb') {
        document.body.classList.remove('mode-splat');
        if (splat) splat.remove(); // Limpiar splat si existe

        // Configurar src
        mv.src = glbUrl(slug);
        mv.iosSrc = usdzUrl(slug);

        // Poster (intentar cargar)
        const posterSrc = `/assets/posters/${slug}.webp`;
        const posterImg = new Image();
        posterImg.onload = () => { mv.poster = posterSrc; };
        posterImg.onerror = () => { mv.poster = '/models/placeholder.webp'; };
        posterImg.src = posterSrc;

        // Aplicar luces INMEDIATAMENTE y al cargar
        applyLighting(mv);
        mv.addEventListener('load', () => {
            applyLighting(mv);
            skel.classList.add('hidden');
            mv.classList.remove('hidden');
            mv.classList.add('is-visible');
        });

        // ConfiguraciÃ³n especÃ­fica de cÃ¡mara por modelo
        if (window.cameraSettings && window.cameraSettings[slug]) {
            const cam = window.cameraSettings[slug];
            if (cam.orbit) mv.cameraOrbit = cam.orbit;
            if (cam.fov) mv.fieldOfView = cam.fov;
            if (cam.minRadius) mv.minCameraOrbit = `auto auto ${cam.minRadius}`;
            if (cam.maxRadius) mv.maxCameraOrbit = `auto auto ${cam.maxRadius}`;
        }
    }

    // 6. LÃ³gica de Carga Splat
    else if (type === 'splat') {
        document.body.classList.add('mode-splat');
        if (mv) mv.remove(); // Limpiar model-viewer para ahorrar memoria

        if (splat) {
            splat.src = `/splat/${slug}/viewer.html?noui=1`;
            splat.classList.remove('hidden');

            splat.onload = () => {
                setTimeout(() => {
                    skel.classList.add('hidden');
                    // Ocultar poster del splat si existe
                    const sp = document.getElementById('splatPoster');
                    if (sp) sp.style.display = 'none';
                }, 1000);
            };
        }
    }

    // 7. Cargar InformaciÃ³n de la pieza
    if (window.loadInfoForSlug) {
        window.loadInfoForSlug(slug, localStorage.getItem('museum-lang') || 'es');
    }

    // 8. Setup Audio
    if (typeof setupAudioFor === 'function') {
        setupAudioFor(slug);
    }

})();
  </script>
  <!-- ==== REGISTRO DEL SERVICE WORKER ==== -->
  <script>
    // --- Swipe down para cerrar la cartela mÃ³vil ---
    (function () {
      const sheet = document.getElementById('infoSheet');
      const dragHandle = document.querySelector('.info-sheet__drag');
      if (!sheet || !dragHandle) return;

      let startY = 0;
      let currentY = 0;
      let isDragging = false;

      const onTouchStart = (e) => {
        startY = e.touches[0].clientY;
        isDragging = true;
        sheet.style.transition = 'none';
      };

      const onTouchMove = (e) => {
        if (!isDragging) return;
        currentY = e.touches[0].clientY;
        const diff = currentY - startY;

        // Solo desplazamos hacia abajo
        if (diff > 0) {
          sheet.style.transform = `translateY(${diff}px)`;
          sheet.style.opacity = `${Math.max(1 - diff / 300, 0.4)}`;
        }
      };

      const onTouchEnd = () => {
        if (!isDragging) return;
        isDragging = false;
        sheet.style.transition = 'transform 0.25s ease, opacity 0.25s ease';

        const diff = currentY - startY;
        if (diff > 120) {
          // cerrar cartela
          sheet.classList.add('hidden');
          sheet.setAttribute('aria-hidden', 'true');
          document.body.classList.remove('sheet-open');
        } else {
          // volver a su sitio
          sheet.style.transform = '';
          sheet.style.opacity = '';
        }
      };

      dragHandle.addEventListener('touchstart', onTouchStart);
      dragHandle.addEventListener('touchmove', onTouchMove);
      dragHandle.addEventListener('touchend', onTouchEnd);
    })();

    // Registro del Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(reg => console.log('âœ… Service Worker registrado para el visor'))
          .catch(err => console.warn('âŒ Error registrando SW:', err));
      });
    }
  </script>
  <script src="/assets/debug-overlay.js"></script>
</body>

</html>
<script>
  // ========================================
  // HELPERS COOLDOWN VISUAL (Inyectado)
  // ========================================
  window.startCooldownVisual = function (btn) {
    if (!btn) return;
    btn.classList.add('is-cooldown');
    const originalText = btn.querySelector('.ar-text')?.textContent || 'Ver en AR';

    let remaining = Math.ceil(7); // 7s hardcoded por seguridad
    const updateText = () => {
      const txt = btn.querySelector('.ar-text');
      if (txt) txt.textContent = `Espere ${remaining}s...`;
    };

    updateText();

    const interval = setInterval(() => {
      remaining--;
      if (remaining <= 0) {
        clearInterval(interval);
        btn.classList.remove('is-cooldown');
        const txt = btn.querySelector('.ar-text');
        if (txt) txt.textContent = 'Ver en AR';
      } else {
        updateText();
      }
    }, 1000);
  };
</script>
