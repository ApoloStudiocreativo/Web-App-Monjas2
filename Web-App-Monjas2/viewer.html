<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#0f1115" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <title>Museo Virtual San Joaqu√≠n y Santa Ana</title>

  <!-- <link rel="prefetch" href="/assets/posters/desktop/cristo-yacente.webp" as="image"> -->
  <link rel="prefetch" href="/assets/audio/cristo-yacente.mp3" as="audio">

  <!-- Preload fuentes cr√≠ticas -->
  <link rel="preload" href="https://fonts.gstatic.com/s/poppins/v20/pxiByp8kv8JHgFVrLGT9Z1xlFQ.woff2" as="font"
    type="font/woff2" crossorigin>
  <link rel="preload" href="https://fonts.gstatic.com/s/lora/v32/0QI6MX1D_JOuGQbT0gvTJPa787weuxJBkq0.woff2" as="font"
    type="font/woff2" crossorigin>

  <!-- Preconnect (mejora de rendimiento fuentes) -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

  <!-- Tipograf√≠a para t√≠tulos -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600&display=swap" rel="stylesheet" media="print"
    onload="this.media='all'">
  <noscript>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght=600&display=swap" rel="stylesheet">
  </noscript>

  <!-- CSS principal -->
  <link rel="stylesheet" href="/index.min.css" />

  <!-- Datos/metadatos -->
  <link rel="preload" href="/assets/info.json" as="fetch" type="application/json" crossorigin="anonymous" />

  <!-- HDR / skybox -->
  <link rel="preload" as="image" href="/assets/hdr/studio_small_09_2k.hdr" />
  <link rel="manifest" href="/manifest.webmanifest">

  <!-- model-viewer (GLB) -->
  <script type="module" src="/vendor/model-viewer-4.0.0.min.js"></script>

  <!-- === FAVICON UNIVERSAL === -->
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/icons/favicon.png">
  <link rel="apple-touch-icon" href="/assets/icons/favicon.png">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0f1115">

  <!-- Tipograf√≠a cl√°sica para cuerpo de texto -->
  <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;500;600&display=swap" rel="stylesheet">

</head>

<body>
  <!-- =========================
         Topbar
         ========================= -->
  <header id="topBar">
    <!-- IZQUIERDA: Flecha + Isotipo -->
    <div class="left-group">
      <a class="back-btn" href="/" aria-label="Volver atr√°s">
        <!-- Flecha minimalista -->
        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
      </a>

      <!-- Isotipo (solo m√≥vil) -->
      <img id="brandMark" src="/assets/brand/isotipo.svg" alt="Museo Virtual" />

      <!-- Logotipo completo (solo escritorio) -->
      <img id="brandLogo" src="/assets/brand/logo-museo.svg" alt="Museo Virtual San Joaqu√≠n y Santa Ana" />
    </div>

    <!-- T√çTULO a la derecha del bot√≥n back -->
    <div class="title-wrapper">
      <h1 id="pieceTitle">Cristo Yacente</h1>
    </div>

    <!-- DERECHA: Bot√≥n Info (m√≥vil) / Galer√≠a (escritorio) -->
    <button id="infoBtn" class="info-btn" type="button" aria-controls="infoSheet" aria-expanded="false">
      Informaci√≥n
    </button>
    <a class="gallery-btn" href="/">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 10L12 3l9 7"></path>
        <line x1="4" y1="10" x2="20" y2="10"></line>
        <line x1="4" y1="22" x2="20" y2="22"></line>
        <line x1="6" y1="10" x2="6" y2="22"></line>
        <line x1="10" y1="10" x2="10" y2="22"></line>
        <line x1="14" y1="10" x2="14" y2="22"></line>
        <line x1="18" y1="10" x2="18" y2="22"></line>
      </svg>
      Ir al Museo
    </a>
  </header>

  <!-- Ayuda de atajos (desktop) -->
  <div id="kbdHelp" class="kbd-help hidden" aria-hidden="true">
    <div class="kbd-help__row"><kbd>Arrastrar</kbd> Rotar</div>
    <div class="kbd-help__row"><kbd>Shift</kbd> + arrastrar ‚Äî Pan</div>
    <div class="kbd-help__row"><kbd>Rueda</kbd> ‚Äî Zoom</div>
    <div class="kbd-help__row"><kbd>H</kbd> ‚Äî Mostrar/ocultar ayuda</div>
  </div>

  <!-- Mensaje si faltan par√°metros -->
  <div id="msg" class="hidden"></div>

  <!-- =========================
         Overlay skeleton (carga)
         ========================= -->
  <div id="skel" class="skeleton">
    <div class="loader-container">
      <div class="loader-circle">
        <div class="loader-progress" id="loaderProgress">0%</div>
      </div>
      <p class="loader-text">
        Cargando experiencia,<br />
        puede tardar un poco seg√∫n tu conexi√≥n
      </p>
    </div>
  </div>

  <!-- =========================
         Vista GLB
         ========================= -->
  <!-- CONTENEDOR EXCLUSIVO DE ESCRITORIO -->
  <div id="viewerContainer" class="desktop-only">
    <model-viewer id="mv" class="hidden" loading="lazy" alt="Modelo 3D" camera-controls touch-action="pan-y" ar
      ar-modes="webxr scene-viewer quick-look" ar-scale="fixed" ar-placement="floor" environment-image="neutral"
      shadow-intensity="1.2" shadow-softness="0.9" exposure="1" camera-orbit="0deg 70deg 1.5m" field-of-view="30deg">
    </model-viewer>

    <div class="glb-poster" id="glbPoster"></div>
    <div class="splat-poster" id="splatPoster"></div>
    <iframe id="splat" class="hidden" loading="lazy"
      allow=" autoplay; fullscreen; xr-spatial-tracking; camera; microphone; gyroscope; accelerometer">
    </iframe>
  </div>


  <!-- CARTELA EXCLUSIVA ESCRITORIO -->
  <aside id="infoPanel" class="desktop-only">
    <div class="info-content">
      <h2 id="infoTitleDesktop">Cristo Yacente</h2>
      <p class="info-meta">Siglo XVIII (1740) ‚Äî Luis Salvador Carmona ‚Äî Madera</p>
      <p class="info-desc">
        Escultura barroca en madera policromada que representa el cuerpo de Cristo tras su descendimiento.
      </p>

      <ul class="info-details">
        <li><strong>Tipolog√≠a:</strong> Madera policromada</li>
        <li><strong>Material:</strong> Madera</li>
        <li><strong>Fecha:</strong> Siglo XVIII (1740)</li>
        <li><strong>Autor:</strong> Luis Salvador Carmona</li>
      </ul>
      <div class="info-actions">
        <button id="audioGuideBtn" class="info-btn-audio">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="5 3 19 12 5 21 5 3"></polygon>
          </svg>
          Escuchar audiogu√≠a
        </button>

        <a href="/" class="info-btn-visit">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
            <polyline points="16 6 12 2 8 6"></polyline>
            <line x1="12" y1="2" x2="12" y2="15"></line>
          </svg>
          Web Cl√°sica
        </a>
      </div>
    </div>
  </aside>

  <!-- =========================
         FABs (Audio + AR)
         ========================= -->
  <div id="fabRow" class="fab-row">
    <!-- AUDIO (izquierda) -->
    <button id="audioBtn" class="audio-fab hidden" type="button" aria-label="Reproducir audio" aria-pressed="false">
      <!-- Icono ALTAVOZ (parado) -->
      <svg class="icon-play" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M4 9v6h3l5 4V5L7 9H4z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"
          stroke-linejoin="round" />
        <path d="M15 10.5a3.5 3.5 0 010 3" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />
        <path d="M17.5 8a6 6 0 010 8" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />
      </svg>
      <!-- Icono PAUSA (reproduciendo) -->
      <svg class="icon-pause" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <rect x="6" y="5" width="4" height="14" rx="1.2" stroke="currentColor" stroke-width="1.8" />
        <rect x="14" y="5" width="4" height="14" rx="1.2" stroke="currentColor" stroke-width="1.8" />
      </svg>
    </button>

    <!-- AR (derecha) -->
    <button id="arBtn" class="ar-fab hidden" type="button" aria-label="Ver en AR">
      <!-- Spinner de carga (oculto por defecto) -->
      <svg class="ar-spinner" viewBox="0 0 24 24" fill="none" style="display: none;">
        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" stroke-linecap="round"
          stroke-dasharray="60" stroke-dashoffset="15" opacity="0.3" />
        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" stroke-linecap="round"
          stroke-dasharray="60" stroke-dashoffset="15">
          <animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="1s"
            repeatCount="indefinite" />
        </circle>
      </svg>
      <!-- Icono AR normal -->
      <svg class="ar-icon" viewBox="0 0 24 24" fill="none">
        <path d="M12 3l8.66 5v8L12 21l-8.66-5V8L12 3zM12 3v18M3.34 8L12 13l8.66-5" stroke="white" stroke-width="1.8"
          stroke-linecap="round" stroke-linejoin="round" />
      </svg>
      <span class="ar-text">Ver en AR</span>
    </button>
  </div>
  <!-- =========================
         Overlay de carga AR
         ========================= -->
  <div id="arLoading" class="ar-loading hidden" aria-hidden="true">
    <div class="spinner" aria-hidden="true"></div>
    <span id="arLoadingText">Preparando experiencia AR‚Ä¶</span>
  </div>

  <!-- =========================
         Cartela (Info Sheet)
         ========================= -->
  <div id="infoSheet" class="info-sheet hidden" aria-hidden="true">
    <div class="info-sheet__drag"></div>
    <button id="infoClose" class="info-sheet__close" aria-label="Cerrar">‚úï</button>
    <div class="info-sheet__content">
      <h2 id="infoTitle">Obra</h2>
      <p class="info-meta" id="infoMeta"></p>
      <p class="info-desc" id="infoDesc"></p>
    </div>
  </div>

  <!-- Link AR iOS oculto -->
  <a id="iosARLink" rel="ar" style="display:none" aria-hidden="true"></a>

  <!-- =========================
         Script principal (sin eliminar nada, solo organizado)
         ========================= -->
  <script>
    function prefetchCommonAssets() {
      const commonAssets = [
        '/assets/info.json',
        '/assets/brand/logo-museo.svg',
        '/assets/brand/isotipo.svg',
        '/index.css',
        '/sw.js'
      ];

      commonAssets.forEach(url => {
        const link = document.createElement('link');
        link.rel = 'prefetch';
        link.href = url;
        document.head.appendChild(link);
      });
    }

    window.addEventListener('load', prefetchCommonAssets);

    // ========================================
    // PRECARGA INTELIGENTE DE MODELOS 3D
    // ========================================
    function preloadModelsFor(slug) {
      if (!slug) return;

      const glbUrl = `/models/${slug}/${slug}.glb`;
      const usdzUrl = `/models/${slug}/${slug}.usdz`;

      console.log(`[Preload] Iniciando precarga de modelos para: ${slug}`);

      // Usar fetch con prioridad baja para no bloquear recursos cr√≠ticos
      fetch(glbUrl, {
        priority: 'low',
        cache: 'force-cache'
      }).then(() => {
        console.log(`[Preload] ‚úÖ GLB precargado: ${slug}`);
      }).catch(err => {
        console.warn(`[Preload] ‚ö†Ô∏è Error precargando GLB:`, err);
      });

      fetch(usdzUrl, {
        priority: 'low',
        cache: 'force-cache'
      }).then(() => {
        console.log(`[Preload] ‚úÖ USDZ precargado: ${slug}`);
      }).catch(err => {
        console.warn(`[Preload] ‚ö†Ô∏è Error precargando USDZ:`, err);
      });
    }

    // ---------------- URL Parsing (Single Source of Truth) ----------------
    function parseURL() {
      const qs = new URLSearchParams(window.location.search);
      let type = (qs.get('type') || '').toLowerCase(); // 'glb' | 'splat'
      let model = (qs.get('model') || '').toLowerCase();
      let figure = (qs.get('figure') || '').toLowerCase();

      // Support for /glb/name or /splat/name paths
      if (!type) {
        const parts = window.location.pathname.split('/').filter(Boolean);
        if (parts[0] === 'splat' && parts[1]) {
          type = 'splat';
          figure = parts[1];
        } else if (parts[0] === 'glb' && parts[1]) {
          type = 'glb';
          model = parts[1];
        } else if (parts.length === 1) {
          type = 'glb';
          model = parts[0];
        }
      }

      // Default to glb if model is present but type is not
      if (!type && (model || figure)) {
        type = figure ? 'splat' : 'glb';
      }

      // FALLBACK: Default to cristo-yacente
      if (!model && !figure) {
        type = 'glb';
        model = 'cristo-yacente';
      }

      return { type, model, figure, slug: model || figure };
    }

    const { type, model, figure, slug } = parseURL();
    window.loadedType = type;
    window.loadedModel = slug;

    console.log('üåê [URL] Detected:', { type, slug });

    document.addEventListener('DOMContentLoaded', () => {

      // üöÄ Iniciar precarga de modelos en background
      if (slug) {
        // Esperar 2 segundos para que carguen recursos cr√≠ticos primero
        setTimeout(() => {
          preloadModelsFor(slug);
        }, 2000);
      }

      // === üåê Selector manual de idioma ===

      // Recuperar idioma guardado o usar espa√±ol por defecto
      let currentLang = localStorage.getItem('museum-lang') || 'es';
      const langToggleBtn = document.getElementById('langToggleBtn');

      if (langToggleBtn) {
        langToggleBtn.textContent = currentLang.toUpperCase();

        langToggleBtn.addEventListener('click', () => {
          currentLang = currentLang === 'es' ? 'en' : 'es';
          localStorage.setItem('museum-lang', currentLang);
          langToggleBtn.textContent = currentLang.toUpperCase();
          loadInfoForSlug(slug, currentLang); // üîÅ Recargar cartela din√°micamente
        });
      }

      // --- Funci√≥n unificada de carga de informaci√≥n ---
      function loadInfoForSlug(slug, lang) {
        const infoPath = `/assets/info${lang === 'en' ? '_en' : ''}.json`;
        fetch(infoPath)
          .then(res => res.json())
          .then(infoData => {
            const info = infoData[slug];
            if (!info) return;

            // M√≥vil
            const infoTitle = document.getElementById('infoTitle');
            const infoMeta = document.getElementById('infoMeta');
            const infoDesc = document.getElementById('infoDesc');
            if (infoTitle && infoMeta && infoDesc) {
              infoTitle.textContent = info.title;
              infoMeta.textContent = `${info.year} ‚Äî ${info.author} ‚Äî ${info.material}`;
              infoDesc.textContent = info.desc;
            }

            // Escritorio
            const infoTitleDesktop = document.getElementById('infoTitleDesktop');
            const infoMetaDesktop = document.querySelector('#infoPanel .info-meta');
            const infoDescDesktop = document.querySelector('#infoPanel .info-desc');
            const infoDetails = document.querySelector('#infoPanel .info-details');

            if (infoTitleDesktop) infoTitleDesktop.textContent = info.title;
            if (infoMetaDesktop) infoMetaDesktop.textContent = `${info.year} ‚Äî ${info.author} ‚Äî ${info.material}`;
            if (infoDescDesktop) infoDescDesktop.textContent = info.desc;
            if (infoDetails) {
              infoDetails.innerHTML = `
          <li><strong>${lang === 'en' ? 'Typology' : 'Tipolog√≠a'}:</strong> ${info.typology || '‚Äî'}</li>
          <li><strong>${lang === 'en' ? 'Material' : 'Material'}:</strong> ${info.material || '‚Äî'}</li>
          <li><strong>${lang === 'en' ? 'Date' : 'Fecha'}:</strong> ${info.year || '‚Äî'}</li>
          <li><strong>${lang === 'en' ? 'Author' : 'Autor'}:</strong> ${info.author || '‚Äî'}</li>
        `;
            }

            console.log(`[Museo] Idioma: ${lang.toUpperCase()} ‚Äî Datos cargados de ${infoPath}`);
          })
          .catch(err => console.error('[Museo] Error cargando info.json:', err));
      }

      // Cargar idioma inicial al abrir la p√°gina
      loadInfoForSlug(slug, currentLang);


      // === üéß SINCRONIZAR CARTELA Y AUDIO (VERSI√ìN ESCRITORIO) ===

      fetch('/assets/info.json')
        .then(res => res.json())
        .then(infoData => {
          const info = infoData[slug];
          if (!info) {
            console.warn(`[Museo] No se encontr√≥ info para "${slug}"`);
            return;
          }

          // üü© Actualizar cartela m√≥vil (ya existente)
          const infoTitle = document.getElementById('infoTitle');
          const infoMeta = document.getElementById('infoMeta');
          const infoDesc = document.getElementById('infoDesc');
          if (infoTitle && infoMeta && infoDesc) {
            infoTitle.textContent = info.title;
            infoMeta.textContent = `${info.year} ‚Äî ${info.author} ‚Äî ${info.material}`;
            infoDesc.textContent = info.desc;
          }

          // üü© Actualizar cartela escritorio
          const infoTitleDesktop = document.getElementById('infoTitleDesktop');
          const infoMetaDesktop = document.querySelector('#infoPanel .info-meta');
          const infoDescDesktop = document.querySelector('#infoPanel .info-desc');
          const infoDetails = document.querySelector('#infoPanel .info-details');

          if (infoTitleDesktop) infoTitleDesktop.textContent = info.title;
          if (infoMetaDesktop) infoMetaDesktop.textContent = `${info.year} ‚Äî ${info.author} ‚Äî ${info.material}`;
          if (infoDescDesktop) infoDescDesktop.textContent = info.desc;

          // üü® Actualizar lista de detalles
          if (infoDetails) {
            infoDetails.innerHTML = `
        <li><strong>Tipolog√≠a:</strong> ${info.typology || '‚Äî'}</li>
        <li><strong>Material:</strong> ${info.material || '‚Äî'}</li>
        <li><strong>Fecha:</strong> ${info.year || '‚Äî'}</li>
        <li><strong>Autor:</strong> ${info.author || '‚Äî'}</li>
      `;
          }

        })
        .catch(err => console.error('[Museo] Error cargando info.json:', err));


      // Estado persistente de la cartela por pieza
      const sheetKeyFor = (s) => `sheet:${s}`;

      // ---------------- Elementos del DOM ----------------
      const fabRow = document.getElementById('fabRow');
      const mv = document.getElementById('mv');
      const splat = document.getElementById('splat');
      const skel = document.getElementById('skel');
      const msg = document.getElementById('msg');
      const arBtn = document.getElementById('arBtn');
      const topBar = document.getElementById('topBar');
      const pieceTitle = document.getElementById('pieceTitle');
      const infoBtn = document.getElementById('infoBtn');
      const sheet = document.getElementById('infoSheet');
      const sheetClose = document.getElementById('infoClose');
      const infoTitle = document.getElementById('infoTitle');
      const infoMeta = document.getElementById('infoMeta');
      const infoDesc = document.getElementById('infoDesc');
      const audioBtn = document.getElementById('audioBtn');

      // === Desktop mode toggle ===
      const mqDesk = window.matchMedia('(min-width: 1025px)');
      function applyDesktopClass() {
        document.body.classList.toggle('is-desktop', mqDesk.matches);
        // En desktop: cartela siempre visible y sin bot√≥n cerrar
        if (mqDesk.matches) {
          // mostrar cartela si hay slug
          try { sheet.classList.remove('hidden'); sheet.setAttribute('aria-hidden', 'false'); } catch { }
        }
      }
      mqDesk.addEventListener?.('change', applyDesktopClass);
      applyDesktopClass();

      // === Cheatsheet: H para mostrar/ocultar (solo desktop) ===
      const kbd = document.getElementById('kbdHelp');
      window.addEventListener('keydown', (e) => {
        if (!document.body.classList.contains('is-desktop')) return;
        if (e.key.toLowerCase() === 'h') {
          kbd.classList.toggle('hidden');
          kbd.setAttribute('aria-hidden', kbd.classList.contains('hidden') ? 'true' : 'false');
        }
      });


      if (infoBtn) {
        infoBtn.setAttribute('aria-controls', 'infoSheet');
        infoBtn.setAttribute('aria-expanded', 'false');
      }

      // Accesibilidad: anuncia el progreso del loader
      const loaderProgressEl = document.getElementById('loaderProgress');
      if (loaderProgressEl) {
        loaderProgressEl.setAttribute('role', 'status');
        loaderProgressEl.setAttribute('aria-live', 'polite');
        loaderProgressEl.setAttribute('aria-atomic', 'true');
      }

      // Wake Lock para evitar que se apague la pantalla mientras se usa la app
      let wakeLock = null;
      async function requestWakeLock() {
        try {
          if ('wakeLock' in navigator && !wakeLock) {
            wakeLock = await navigator.wakeLock.request('screen');
            wakeLock.addEventListener('release', () => {
              wakeLock = null;
            });
          }
        } catch (e) {
          // Algunos m√≥viles lo bloquean; sin drama
          console.debug('WakeLock no disponible:', e?.message || e);
        }
      }
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
          requestWakeLock();
        } else if (wakeLock) {
          try {
            wakeLock.release();
          } catch { }
          wakeLock = null;
        }
      });
      // Primer intento en cuanto cargue
      requestWakeLock();

      // ---------------- Rutas y helpers ----------------
      const glbUrl = (name) => `/models/${name}/${name}.glb`;
      const usdzUrl = (name) => `/models/${name}/${name}.usdz`;
      const splatUrl = (name) => `/splat/${name}/viewer.html?noui=1`;

      // === Firma ef√≠mera de URLs (token 60s) ===
      const signedCache = new Map();

      async function signPath(path) {
        // Devuelve URL absoluta firmada o lanza error
        const r = await fetch(`/api/sign?f=${encodeURIComponent(path)}`, {
          cache: 'no-store',
          credentials: 'omit'
        });
        if (!r.ok) throw new Error('sign failed');
        const { url } = await r.json();
        return url;
      }

      async function signedOrPlain(path) {
        try {
          if (signedCache.has(path)) return signedCache.get(path);
          const url = await signPath(path);
          signedCache.set(path, url);
          return url;
        } catch {
          // Fallback si algo falla (no bloquea la UX)
          return path;
        }
      }


      async function exists(url) {
        try {
          const r = await fetch(url, {
            method: 'HEAD',
            cache: 'force-cache',
            priority: 'low',
            keepalive: true
          });
          return r.ok;
        } catch {
          return false;
        }
      }

      // Helpers de plataforma
      const isIOS =
        /iPad|iPhone|iPod/i.test(navigator.userAgent) ||
        (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      const isAndroid = /Android/.test(navigator.userAgent);

      // Helper para resetear listeners de un bot√≥n sin cambiar su HTML ni clases
      function resetClick(el) {
        const clone = el.cloneNode(true);
        el.replaceWith(clone);
        return clone; // el nuevo nodo sin listeners
      }

      // Helpers de visibilidad
      function show(el) {
        if (el) el.classList.remove('hidden');
      }
      function hide(el) {
        if (el) el.classList.add('hidden');
      }

      // üü¢ Haptics robusto + fallback visual
      function supportsVibrate() {
        return typeof navigator !== 'undefined' && typeof navigator.vibrate === 'function';
      }
      function addHapticFeedback(selector, pattern = [18]) {
        const btn = document.querySelector(selector);
        if (!btn) return;

        // Fallback visual (escala r√°pida) para iOS/desktop
        const pulse = () => {
          btn.classList.add('tap-pulse');
          setTimeout(() => btn.classList.remove('tap-pulse'), 120);
        };

        const onDown = () => {
          let didVibrate = false;
          try {
            if (supportsVibrate()) {
              // En algunos Android un solo valor peque√±o se ignora: patr√≥n corto ayuda
              didVibrate = navigator.vibrate(pattern);
            }
          } catch { }
          if (!didVibrate) pulse();
        };

        // feedback inmediato
        btn.addEventListener('pointerdown', onDown);
      }
      addHapticFeedback('#infoBtn', [14]);
      addHapticFeedback('#infoClose', [14]);
      addHapticFeedback('#arBtn', [20]);
      addHapticFeedback('#audioBtn', [12, 8]);
      addHapticFeedback('#homeBtn', [12]);
      addHapticFeedback('#homeBtn', [12]);


      console.debug('[haptics] vibrate supported?', supportsVibrate());

      // Toast reutilizable (mensaje flotante)
      function showToast(message = 'Pulsa de nuevo para habilitar el audio', ms = 1800) {
        let t = document.querySelector('.toast');
        if (!t) {
          t = document.createElement('div');
          t.className = 'toast';
          document.body.appendChild(t);
        }
        t.textContent = message;
        t.classList.add('show');
        window.clearTimeout(showToast._timer);
        showToast._timer = window.setTimeout(() => t.classList.remove('show'), ms);
      }

      // Mensaje de error con CTA de reintento
      function showErrorAndRetry(kind, name, retryFn) {
        const cta = document.createElement('div');
        cta.style.cssText = 'margin-top:12px; display:flex; gap:8px; justify-content:center;';
        const btnRetry = document.createElement('button');
        btnRetry.textContent = 'Reintentar';
        btnRetry.className = 'info-btn';
        btnRetry.style.minWidth = 'auto';
        btnRetry.onclick = () => {
          const msg = document.getElementById('msg');
          if (msg) msg.classList.add('hidden');
          retryFn?.();
        };

        const msg = document.getElementById('msg');
        if (msg) {
          msg.innerHTML = `
              <div>
                <b>No se pudo cargar la pieza</b><br/><br/>
                Tipo: <code>${kind}</code> ¬∑ Id: <code>${name}</code><br/>
                Puede ser tu conexi√≥n o un archivo temporalmente no disponible.
              </div>`;
          msg.appendChild(cta);
          cta.appendChild(btnRetry);
          msg.classList.remove('hidden');
        }

        showToast('Error de carga. Pulsa ‚ÄúReintentar‚Äù.', 2200);
      }

      // Habilita/Deshabilita el bot√≥n AR visual y funcionalmente
      function setArEnabled(enabled) {
        const btn = document.getElementById('arBtn');
        if (!btn) return;
        if (enabled) {
          btn.removeAttribute('disabled');
          btn.classList.remove('is-disabled');
        } else {
          btn.setAttribute('disabled', 'true');
          btn.classList.add('is-disabled');
        }
      }

      // --- Standalone detector (A2HS) ---
      function isStandalone() {
        const iosStandalone = ('standalone' in navigator) && navigator.standalone;
        const pwaStandalone = window.matchMedia && window.matchMedia('(display-mode: standalone)').matches;
        return iosStandalone || pwaStandalone;
      }

      // --- Watchdog de progreso de <model-viewer> ---
      function startProgressWatchdog(mvEl, { timeoutMs = 8000, onStall } = {}) {
        let progressed = false;
        const onProg = (e) => {
          const p = e?.detail?.totalProgress ?? 0;
          if (p > 0) progressed = true;
        };
        mvEl.addEventListener('progress', onProg, { passive: true });
        const timer = setTimeout(() => {
          mvEl.removeEventListener('progress', onProg);
          if (!progressed) onStall?.();
        }, timeoutMs);
        return () => { clearTimeout(timer); mvEl.removeEventListener('progress', onProg); };
      }


      // ---------------- Audio por figura (bot√≥n siempre visible + cleanup) ----------------
      let audio = null;
      let audioCleanup = () => { };
      async function setupAudioFor(id) {
        // Mapeo de archivos de audio espec√≠ficos que no coinciden con el slug o tienen otra extensi√≥n
        const audioMap = {
          'jesus-en-la-cruz': 'Cristo_de_papel.mp3',
          'bargueno-relicario': 'bargue√±o_relicario.mp3',
          'cuadro-la-elevacion-de-la-cruz': 'cuadro_Elevacion_de_la_cruz.mp3',
          'virgen-asuncion': 'virgen-asuncion.mp3',
          'casulla-santa-ana': 'Casulla.mp3',
          'goya-uno': 'Cuadro_Goya_Santa_Lutgarda_.mp3',
          'goya-dos': 'Cuadro_Goya_El_transito_de_san_Jose.mp3',
          'goya-tres': 'Cuadro_Goya_SanBernardo.mp3',
          'bayeu-uno': 'Cuadro_Bayeu_Santa_Escolastica.mp3',
          'bayeu-dos': 'Cuadro_Bayeu_Inmaculada.mp3',
          'bayeu-tres': 'Cuadro_Bayeu_SanBenito.mp3',
          'virgen-de-mena': 'Dolorosa.mp3',
          'virgen-romanica': 'Virgen_Romanica.mp3',
          'novisimos': 'Novisimos.mp3',
          'reliquia-dorada': 'custodia-trofeo.mp3'
        };

        const fileName = audioMap[id] || `${id}.mp3`;
        const audioPath = `/assets/audio/${fileName}`;
        const audioBtn = document.getElementById('audioBtn');
        const audioGuideBtn = document.getElementById('audioGuideBtn');

        // Detener y limpiar audios anteriores
        if (audio) {
          try { audio.pause(); } catch { }
          audio = null;
        }

        try { audioCleanup(); } catch { }

        // Crear audio nuevo
        console.log(`[Audio] Intentando cargar: ${audioPath}`);
        audio = new Audio(audioPath);
        audio.loop = true;
        audio.preload = 'auto';

        // Funci√≥n para alternar play/pause y actualizar botones varios
        const toggleAudio = async (btn) => {
          if (!audio) return;
          if (audio.paused) {
            try {
              await audio.play();
              btn.classList.add('is-playing');
              if (btn === audioGuideBtn) {
                btn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="6" y="5" width="4" height="14" rx="1.2"></rect>
              <rect x="14" y="5" width="4" height="14" rx="1.2"></rect>
            </svg>
            Pausar audiogu√≠a
          `;
              }
            } catch (err) {
              console.warn('Audio bloqueado o no disponible:', err);
            }
          } else {
            audio.pause();
            btn.classList.remove('is-playing');
            if (btn === audioGuideBtn) {
              btn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="5 3 19 12 5 21 5 3"></polygon>
          </svg>
          Escuchar audiogu√≠a
        `;
            }
          }
        };

        // Listeners para ambos botones
        if (audioBtn) {
          audioBtn.classList.remove('hidden');
          audioBtn.onclick = () => toggleAudio(audioBtn);
        }
        if (audioGuideBtn) {
          audioGuideBtn.onclick = () => toggleAudio(audioGuideBtn);
        }

        // Limpieza
        audioCleanup = () => {
          try { audio.pause(); } catch { }
          audio = null;
        };
      }

      // ---------------- AR helpers ----------------
      // ========================================
      // VARIABLES DE COOLDOWN AR
      // ========================================
      const AR_COOLDOWN_MS = 7000; // 7 segundos de cooldown
      let lastARClickTime = 0; // Timestamp del √∫ltimo click en AR

      function openARFor(name) {
        const usdz = usdzUrl(name);
        const glb = glbUrl(name);
        const titleEl = document.getElementById('infoTitle');
        const arTitle = encodeURIComponent((titleEl?.textContent || name).trim());

        if (isIOS) {
          window.location.href = usdz;
          return;
        }
        if (isAndroid) {
          const file = new URL(glb, location.origin).toString();
          const intent = `intent://arvr.google.com/scene-viewer/1.0?file=${encodeURIComponent(
            file
          )}&mode=ar_preferred&title=${arTitle}#Intent;scheme=https;package=com.google.android.googlequicksearchbox;action=android.intent.action.VIEW;end;`;
          window.location.href = intent.replace(";end;", ";S.browser_fallback_url=" + encodeURIComponent(file) + ";end;");
        }
      }

      function openQuickLookSync(slug) {
        try {
          const link = document.getElementById('iosARLink');
          if (!link) return false;
          const ts = Date.now(); // cache-buster (cada click es "nuevo")
          link.setAttribute('href', preSigned?.usdz || usdzUrl(slug));
          link.click(); // s√≠ncrono, en la misma pila del gesto
          return true;
        } catch {
          return false;
        }
      }

      // ========================================
      // MEJORAS DE FEEDBACK AR - INSTRUCCIONES
      // ========================================

      /*
      INSTRUCCIONES PARA IMPLEMENTAR:
      
      1. Busca en index.html las l√≠neas 782-788 que contienen:
         
            // Overlay "Abriendo AR‚Ä¶."
            function showARLoading() {
              const el = document.getElementById('arLoading');
              if (!el) return;
              el.classList.remove('hidden');
              requestAnimationFrame(() => el.classList.add('visible'));
            }
      
      2. Reempl√°zalas con el siguiente c√≥digo:
      */

      // ========================================
      // C√ìDIGO NUEVO PARA showARLoading
      // ========================================

      // Overlay "Abriendo AR‚Ä¶." con feedback instant√°neo
      let arLoadingTimeout = null;

      function showARLoading() {
        console.log('üî• showARLoading() LLAMADO');

        const el = document.getElementById('arLoading');
        const btn = document.getElementById('arBtn');
        const textEl = document.getElementById('arLoadingText');

        if (!el) {
          console.error('‚ùå NO SE ENCONTR√ì #arLoading');
          return;
        }

        console.log('‚úÖ Mostrando overlay AR');

        // üî• FEEDBACK INSTANT√ÅNEO: Cambiar bot√≥n a estado loading
        if (btn) {
          btn.classList.add('is-loading');
          btn.setAttribute('disabled', 'true');
          const arText = btn.querySelector('.ar-text');
          if (arText) arText.textContent = 'Preparando‚Ä¶';
          try {
            if (navigator.vibrate) navigator.vibrate(20);
          } catch { }
        }

        // Mensaje espec√≠fico por plataforma
        if (textEl) {
          if (isIOS) {
            textEl.textContent = 'Cargando Realidad Aumentada...';
          } else if (isAndroid) {
            textEl.textContent = 'Cargando Realidad Aumentada...';
          } else {
            textEl.textContent = 'Cargando Realidad Aumentada...';
          }
        }

        // üö® FORZAR OVERLAY A APARECER Y MANTENERSE
        el.classList.remove('hidden');
        el.style.display = 'flex';
        el.style.position = 'fixed';
        el.style.inset = '0';
        el.style.zIndex = '99999';
        el.style.background = 'rgba(10, 12, 16, 0.95)';
        el.style.visibility = 'visible';
        el.style.opacity = '1';
        el.classList.add('visible');

        console.log('‚úÖ Overlay visible con opacity 1');

        // Timeout de seguridad: 60s para conexiones MUY lentas
        clearTimeout(arLoadingTimeout);
        arLoadingTimeout = setTimeout(() => {
          console.warn('‚è±Ô∏è TIMEOUT: 60s - ocultando overlay por timeout');
          hideARLoading();
        }, 60000); // 60 segundos
      }

      // ========================================
      // FIN DEL C√ìDIGO
      // ========================================

      /*
      NOTA: La funci√≥n hideARLoading() ya est√° correctamente actualizada en las l√≠neas 789-809.
      No necesitas modificarla.
      
      RESULTADO ESPERADO:
      - Al tocar el bot√≥n AR, cambiar√° INMEDIATAMENTE a color naranja
      - Mostrar√° un spinner girando
      - El texto cambiar√° a "Preparando‚Ä¶"
      - Vibrar√° el dispositivo (en Android)
      - El overlay aparecer√° con mensaje espec√≠fico por plataforma
      - Si tarda m√°s de 10s, se ocultar√° autom√°ticamente
      */



      function hideARLoading() {
        const el = document.getElementById('arLoading');
        const btn = document.getElementById('arBtn');

        if (!el) return;

        // Limpiar timeout
        clearTimeout(arLoadingTimeout);

        // Restaurar bot√≥n a estado normal
        if (btn) {
          btn.classList.remove('is-loading');
          btn.removeAttribute('disabled');

          const arText = btn.querySelector('.ar-text');
          if (arText) arText.textContent = 'Ver en AR';
        }

        el.classList.remove('visible');
        setTimeout(() => el.classList.add('hidden'), 250);
      }
      // ========================================
      // SOLUCI√ìN FINAL PARA EL OVERLAY AR
      // ========================================

      /**
       * PROBLEMA IDENTIFICADO:
       * El overlay S√ç aparece pero desaparece inmediatamente (flashazo)
       * porque el evento 'visibilitychange' lo oculta cuando cambias a la app de AR.
       * 
       * SOLUCI√ìN:
       * Comentar/eliminar el listener de visibilitychange
       */

      // ========================================
      // PASO 1: Busca las l√≠neas 906-915 en index.html
      // ========================================
      // Deber√≠as ver esto:

      // Solo ocultar overlay cuando el usuario vuelve a la p√°gina
      // (esto permite que el overlay se mantenga mientras AR se abre)
      document.addEventListener('visibilitychange', () => {
        // Esperar un poco para asegurar que AR realmente se abri√≥
        if (!document.hidden) {
          setTimeout(() => {
            hideARLoading();
          }, 500);
        }
      });

      // ========================================
      // PASO 2: REEMPL√ÅZALO con esto (comentado):
      // ========================================

      // ‚ö†Ô∏è DESHABILITADO: No ocultar autom√°ticamente el overlay
      // El overlay debe mantenerse visible hasta que AR cargue completamente
      // Solo se ocultar√° por timeout (60s)
      /*
      document.addEventListener('visibilitychange', () => {
        if (!document.hidden) {
          setTimeout(() => {
            hideARLoading();
          }, 500);
        }
      });
      */

      // ---------------- Info JSON ----------------
      async function loadInfoDataOrFallback(current, lang = "es") {
        try {
          const file = lang === "en" ? "/assets/info_en.json" : "/assets/info.json";
          const res = await fetch(file, { cache: "no-store" });
          if (!res.ok) throw new Error("no info.json");
          const json = await res.json();
          console.log(`‚úÖ Datos cargados (${lang}):`, json);
          return json || current;
        } catch (e) {
          console.warn("‚ö†Ô∏è Error cargando info.json:", e);
          return current;
        }
      }

      // ---------------- Cartela ----------------
      function showHelp() {
        skel.classList.add('hidden');
        msg.classList.remove('hidden');
        msg.innerHTML = `
            <div>
              <b>Falta par√°metro en la URL.</b><br/><br/>
              Usa ejemplos:<br/>
              <code>?type=glb&model=cristo-yacente</code><br/>
              <code>?type=splat&figure=calvo-anillo</code>
            </div>`;
      }

      let infoData = {
        'cristo-yacente': {
          title: 'Cristo Yacente',
          meta: 's. XVII ¬∑ Autor/a desconocido/a',
          desc: 'Descripci√≥n pendiente.'
        },
        'virgen-romanica': {
          title: 'Virgen Rom√°nica',
          meta: 's. XII ¬∑ Talla policromada',
          desc: 'Descripci√≥n pendiente.'
        },
        'san-jose-con-el-nino': {
          title: 'San Jos√© con el Ni√±o',
          meta: 's. XVIII',
          desc: 'Descripci√≥n pendiente.'
        },
        'jesus-en-la-cruz': {
          title: 'Cristo en la Cruz',
          meta: 's. XVII',
          desc: 'Descripci√≥n pendiente.'
        }
      };

      // C√°mara por figura
      const cameraSettings = {
        'cristo-yacente': {
          orbit: '53deg 43deg 100%',
          fov: '22deg',
          target: '0m 2m 0m',
          minRadius: '1m',
          maxRadius: '2.8m',
          minFov: '22deg',
          maxFov: '30deg'
        },
        'jesus-en-la-cruz': {
          orbit: '-88deg 71deg 100%',
          fov: '27deg',
          target: '-1.91m -0.14m 0.34m',
          minRadius: '3m',
          maxRadius: '14.8m',
          minFov: '22deg',
          maxFov: '77deg'
        },
        'san-jose-con-el-nino': {
          orbit: '133deg 92deg 139%',
          fov: '37deg',
          target: '-0.27m 2.74m -0.03m',
          minRadius: '2.7m',
          maxRadius: '6.6m',
          minFov: '22deg',
          maxFov: '45deg'
        },
        'san-bernardo-con-la-virgen': {
          orbit: '-4deg 80deg 100%',
          fov: '47deg',
          target: '0.07m 1.53m 2m',
          minRadius: '2.1m',
          maxRadius: '4.1m',
          minFov: '22deg',
          maxFov: '47deg'
        },
        'virgen-asuncion': {
          orbit: '-81deg 70deg 100%',
          fov: '45deg',
          target: '-0.05m 1.8m 0.05m',
          minRadius: '2.1m',
          maxRadius: '5.5m',
          minFov: '20deg',
          maxFov: '45deg'
        },
        'virgen-de-mena': {
          orbit: '-89deg 70deg 100%',
          fov: '30deg',
          target: '0.09m 0.95m 0.02m',
          minRadius: '1.6m',
          maxRadius: '5.5m',
          minFov: '22deg',
          maxFov: '30deg'
        },
        'virgen-romanica': {
          orbit: '-180deg 70deg 100%',
          fov: '45deg',
          target: '-0.32m 2.25m 2m',
          minRadius: '3.9m',
          maxRadius: '8.3m',
          minFov: '20deg',
          maxFov: '45deg'
        },
        'ecce-homo': {
          orbit: '133deg 70deg 100%',
          fov: '45deg',
          target: '0.41m 1.5m -0.37m',
          minRadius: '3.3m',
          maxRadius: '10m',
          minFov: '20deg',
          maxFov: '45deg'
        },
        'reliquia-dorada': {
          orbit: '1deg 89deg 100%',
          fov: '20deg',
          target: '0m 0m 0m',
          minRadius: '5.4m',
          maxRadius: '8.3m',
          minFov: '20deg',
          maxFov: '56deg'
        },
        'bargueno-relicario': {
          orbit: '-180deg 70deg 100%',
          fov: '64deg',
          target: '-0.08m 0.97m 0.69m',
          minRadius: '3m',
          maxRadius: '8.8m',
          minFov: '20deg',
          maxFov: '64deg'
        },
        'cristo-atado-a-la-columna': {
          orbit: '-2deg 70deg 100%',
          fov: '50deg',
          target: '0.11m 1.31m -0.64m',
          minRadius: '1.9m',
          maxRadius: '4.9m',
          minFov: '22deg',
          maxFov: '50deg'
        },
        'jesus-atado-a-la-columna': {
          orbit: '-2deg 70deg 100%',
          fov: '50deg',
          target: '0.11m 1.31m -0.64m',
          minRadius: '1.9m',
          maxRadius: '4.9m',
          minFov: '22deg',
          maxFov: '50deg'
        },
        'tapiz': {
          orbit: '92deg 90deg 100%',
          fov: '57deg',
          target: '-0.03m -0.02m -0.07m',
          minRadius: '1m',
          maxRadius: '3.7m',
          minFov: '25deg',
          maxFov: '57deg'
        },
        'casulla-santa-ana': {
          orbit: '-92deg 70deg 100%',
          fov: '45deg',
          target: '0.17m 1.71m -0.11m',
          minRadius: '5.6m',
          maxRadius: '17.9m',
          minFov: '25deg',
          maxFov: '45deg'
        },
        'novisimos': {
          orbit: '-87deg 89deg 100%',
          fov: '51deg',
          target: '0.02m 0m 0.05m',
          minRadius: '1m',
          maxRadius: '1.1m',
          minFov: '22deg',
          maxFov: '51deg'
        },
        'goya-uno': {
          orbit: '3deg 85deg 100%',
          fov: '60deg',
          target: '0.09m 0.84m -0.15m',
          minRadius: '1.8m',
          maxRadius: '3.5m',
          minFov: '10deg',
          maxFov: '60deg'
        },
        'goya-dos': {
          orbit: '-91deg 88deg 100%',
          fov: '59deg',
          target: '-2m 2.01m -0.24m',
          minRadius: '1.6m',
          maxRadius: '8.4m',
          minFov: '10deg',
          maxFov: '60deg'
        },
        'goya-tres': {
          orbit: '-92deg 89deg 100%',
          fov: '60deg',
          target: '-0.37m 1.5m -0.13m',
          minRadius: '4.6m',
          maxRadius: '10.4m',
          minFov: '10deg',
          maxFov: '60deg'
        },
        'bayeu-uno': {
          orbit: '-91deg 89deg 100%',
          fov: '60deg',
          target: '0m 1.77m -0.05m',
          minRadius: '5.2m',
          maxRadius: '12.3m',
          minFov: '10deg',
          maxFov: '60deg'
        },
        'bayeu-dos': {
          orbit: '-89deg 88deg 100%',
          fov: '60deg',
          target: '0m 1.48m 0m',
          minRadius: '6.7m',
          maxRadius: '11.5m',
          minFov: '10deg',
          maxFov: '60deg'
        },
        'bayeu-tres': {
          orbit: '-89deg 91deg 100%',
          fov: '60deg',
          target: '0.49m 0.7m 0.17m',
          minRadius: '3m',
          maxRadius: '3.4m',
          minFov: '10deg',
          maxFov: '60deg'
        },
        'cuadro-la-elevacion-de-la-cruz': {
          orbit: '-86deg 89deg 100%',
          fov: '76deg',
          target: '0.13m -1m 0.57m',
          minRadius: '20m',
          maxRadius: '25.2m',
          minFov: '10deg',
          maxFov: '76deg'
        }
      };

      window.cameraSettings = cameraSettings;

      function buildMeta(d) {
        if (!d) return '';
        if (d.author || d.year || d.material) {
          const parts = [];
          if (d.year) parts.push(d.year);
          if (d.author) parts.push(d.author);
          if (d.material) parts.push(d.material);
          return parts.filter(Boolean).join(' ¬∑ ');
        }
        return d.meta || '';
      }

      function renderInfo(s) {
        const d = infoData[s] || {};
        const nice = (x) => (x || s || '').replace(/-/g, ' ').trim();

        if (topBar && s) {
          topBar.classList.remove('hidden');
          pieceTitle.textContent = d.title || nice(s);
        }
        infoTitle.textContent = d.title || nice(s);
        infoMeta.textContent = buildMeta(d);

        const desc = d.desc || '';
        const extras = [];
        if (d.typology) extras.push(`<div><strong>Tipolog√≠a:</strong> ${d.typology}</div>`);
        if (d.material) extras.push(`<div><strong>Material:</strong> ${d.material}</div>`);
        if (d.technique) extras.push(`<div><strong>T√©cnica:</strong> ${d.technique}</div>`);
        if (d.dimensions) extras.push(`<div><strong>Dimensiones:</strong> ${d.dimensions}</div>`);
        if (d.year) extras.push(`<div><strong>Fecha:</strong> ${d.year}</div>`);
        if (d.author) extras.push(`<div><strong>Autor:</strong> ${d.author}</div>`);

        const extrasHtml = extras.length ? `<div class="info-extra">${extras.join('')}</div>` : '';
        infoDesc.innerHTML = [desc, extrasHtml].filter(Boolean).join('');

        // Actualizar <title> del documento
        try {
          const txt = (infoTitle?.textContent || s || 'Museo Virtual').trim();
          if (txt) document.title = `${txt} ¬∑ Museo Virtual San Joaqu√≠n y Santa Ana`;
        } catch { }
      }

      // Panel/cartela UI
      function openSheet() {
        renderInfo(slug);
        sheet.classList.remove('hidden');
        sheet.setAttribute('aria-hidden', 'false');
        document.body.classList.add('sheet-open');

        if (infoBtn) {
          infoBtn.setAttribute('aria-expanded', 'true');
          infoBtn.setAttribute('aria-label', 'Ocultar informaci√≥n');
        }

        if (slug) {
          try {
            localStorage.setItem(sheetKeyFor(slug), 'open');
          } catch { }
        }
      }

      function closeSheet() {
        sheet.classList.add('hidden');
        sheet.setAttribute('aria-hidden', 'true');
        document.body.classList.remove('sheet-open');

        if (infoBtn) {
          infoBtn.setAttribute('aria-expanded', 'false');
          infoBtn.setAttribute('aria-label', 'Mostrar informaci√≥n');
        }

        if (slug) {
          try {
            localStorage.setItem(sheetKeyFor(slug), 'closed');
          } catch { }
        }
      }

      function toggleSheet() {
        const hidden = sheet.classList.contains('hidden');
        hidden ? openSheet() : closeSheet();
      }

      if (infoBtn) infoBtn.addEventListener('click', toggleSheet);
      sheetClose.addEventListener('click', closeSheet);
      sheet.addEventListener('click', (e) => {
        if (e.target === sheet) closeSheet();
      });

      window.addEventListener('keydown', (e) => {
        // Ignorar si escribes dentro de inputs/textarea/contenteditable
        const t = e.target;
        const typing =
          t &&
          (t.tagName === 'INPUT' || t.tagName === 'TEXTAREA' || t.isContentEditable);
        if (typing) return;

        if (e.key === 'Escape') {
          closeSheet();
        } else if (e.key.toLowerCase() === 'i') {
          toggleSheet();
        }
      });

      /* === Desktop mode: barra lateral fija + sin AR === */
      const DESKTOP_MQ = window.matchMedia('(min-width: 1024px)');
      function applyDesktopMode() {
        const isDesktop = DESKTOP_MQ.matches && !/Android|iPhone|iPad/i.test(navigator.userAgent);
        document.body.classList.toggle('is-desktop', isDesktop);

        // En desktop: cartela siempre visible como lateral
        const sheet = document.getElementById('infoSheet');
        const topBar = document.getElementById('topBar');
        if (isDesktop) {
          // Asegura topbar y cartela visibles
          topBar?.classList.remove('hidden');
          sheet?.classList.remove('hidden');
          sheet?.setAttribute('aria-hidden', 'false');
          document.body.classList.add('sheet-open');

          // Oculta AR (aunque el CSS ya lo esconde)
          const arBtn = document.getElementById('arBtn');
          if (arBtn) {
            arBtn.setAttribute('disabled', 'true');
            arBtn.classList.add('is-disabled', 'hidden');
          }
        } else {
          // Vuelve a comportamiento m√≥vil (cartela controlada por el bot√≥n)
          document.body.classList.remove('sheet-open');
          // no forzamos hidden aqu√≠: de eso se encarga tu l√≥gica actual
        }
      }
      DESKTOP_MQ.addEventListener?.('change', applyDesktopMode);
      applyDesktopMode();

      // üëâ Forzar reglas de escritorio desde JS (defensa extra por si alg√∫n handler intenta cerrar)
      const IS_DESKTOP = window.matchMedia('(min-width: 1024px)').matches;
      if (IS_DESKTOP) {
        try {
          // Forzar cartela abierta
          const sheet = document.getElementById('infoSheet');
          const infoBtn = document.getElementById('infoBtn');
          const sheetClose = document.getElementById('infoClose');

          if (sheet) {
            sheet.classList.remove('hidden');
            sheet.setAttribute('aria-hidden', 'false');
            document.body.classList.add('sheet-open');
          }
          // Ocultar controles de abrir/cerrar
          if (infoBtn) infoBtn.style.display = 'none';
          if (sheetClose) sheetClose.style.display = 'none';

          // Neutralizar posibles cierres por teclado (Esc) u otros
          window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
              e.stopImmediatePropagation();
              e.preventDefault();
            }
          }, true);
        } catch { }
      }
      // ---------------- Inicializaci√≥n ----------------
      (async function init() {
        try {
          if (type === 'glb' && model) {
            document.body.classList.remove('mode-splat');

            // Fuente GLB
            mv.src = glbUrl(model);
            // Prefirmamos GLB y USDZ antes de mostrar AR (evita async en el click iOS)
            const preSigned = {
              glb: await signedOrPlain(glbUrl(model)),
              usdz: await signedOrPlain(usdzUrl(model))
            };

            mv.src = preSigned.glb;          // <model-viewer> carga con token
            mv.iosSrc = preSigned.usdz;      // Quick Look listo con token

            // Mantener poster visible hasta que cargue
            const posterEl = document.querySelector('.glb-poster');
            if (posterEl) posterEl.classList.remove('loaded');

            mv.addEventListener('load', () => {
              setTimeout(() => posterEl?.classList.add('loaded'), 300);
            });


            const stopWatchdog = startProgressWatchdog(mv, {
              timeoutMs: isStandalone() ? 7000 : 10000,
              onStall: () => {
                // Sin progreso real: muestra CTA y reintenta con cache-buster
                showErrorAndRetry('glb', model, () => {
                  const bust = `?v=${Date.now()}`;
                  mv.src = glbUrl(model) + bust;

                  // Segundo watchdog por si sigue atascado
                  startProgressWatchdog(mv, {
                    timeoutMs: 9000,
                    onStall: () => showToast('Todav√≠a no hay datos. Reintenta en unos segundos.', 2200)
                  });

                  // Re-mostrar p√≥ster y skeleton durante el reintento
                  const gp = document.getElementById('glbPoster');
                  if (gp) { gp.classList.remove('fade-out'); gp.classList.add('visible'); }
                  const sk = document.getElementById('skel');
                  if (sk) { sk.classList.remove('hidden'); sk.style.opacity = '1'; }
                });
              }
            });
            // Al cargar, paramos el watchdog
            mv.addEventListener('load', () => { try { stopWatchdog?.(); } catch { } }, { once: true });


            // Deshabilita AR hasta que el modelo est√© listo
            setArEnabled(false);

            // Funci√≥n de reintento (con cache-buster) y rehacer p√≥ster overlay si existe
            const retryGlb = () => {
              const sk = document.getElementById('skel');
              if (sk) {
                sk.classList.remove('hidden');
                sk.style.opacity = '1';
              }
              const bust = `?v=${Date.now()}`;
              mv.src = glbUrl(model) + bust;

              const gp = document.getElementById('glbPoster');
              if (gp) {
                gp.classList.remove('fade-out');
                gp.classList.add('visible');
              }
            };

            // Si model-viewer reporta error: mostramos CTA de reintento
            mv.addEventListener('error', () => {
              const sk = document.getElementById('skel');
              if (sk) {
                sk.style.opacity = '0';
                setTimeout(() => sk.classList.add('hidden'), 400);
              }
              showErrorAndRetry('glb', model, retryGlb);
            });

            // Auto-reintentar una vez al recuperar conexi√≥n si el estado era de error
            window.addEventListener('online', () => {
              const msg = document.getElementById('msg');
              if (msg && !msg.classList.contains('hidden')) retryGlb();
            });

            // ‚ñº‚ñº A√ëADE ESTA L√çNEA AQU√ç ‚ñº‚ñº
            mv.classList.remove('hidden');

            // Failsafe: oculta el skeleton si alg√∫n navegador no dispara 'load'
            setTimeout(() => {
              const sk = document.getElementById('skel');
              if (sk && !sk.classList.contains('hidden')) {
                sk.style.opacity = '0';
                setTimeout(() => sk.classList.add('hidden'), 600);
              }
            }, 12000);

            // === Indicador de progreso del modelo ===
            const progressEl = document.getElementById('loaderProgress');
            if (mv) {
              mv.addEventListener('progress', (e) => {
                const ratio = Math.round(e.detail.totalProgress * 100);
                if (progressEl) progressEl.textContent = `${ratio}%`;
              });

              // ‚ñ∂ P√ìSTER GLB (overlay separado para poder hacer fade)
              let glbPoster = document.getElementById('glbPoster');
              if (!glbPoster) {
                glbPoster = document.createElement('div');
                glbPoster.id = 'glbPoster';
                glbPoster.className = 'glb-poster';

                // Inyectar dentro del marco izquierdo (viewerContainer)
                const viewerContainer = document.getElementById('viewerContainer');
                if (viewerContainer) viewerContainer.prepend(glbPoster);
                else document.body.appendChild(glbPoster); // fallback de seguridad
              }

              // ‚úÖ Detectar si es escritorio o m√≥vil
              const isDesktop = window.matchMedia('(min-width: 1024px)').matches;
              const folder = isDesktop ? 'desktop' : 'mobile';

              // ‚úÖ Crear URL adaptativa (con cache-buster)
              const glbPosterUrl = (await exists(`/assets/posters/${folder}/${model}.webp`))
                ? `/assets/posters/${folder}/${model}.webp?v=${Date.now()}`
                : '/models/placeholder.webp';

              // ‚úÖ Aplicar el poster como fondo del overlay (solo si no es cristo-yacente)
              if (model === 'cristo-yacente') {
                glbPoster.style.display = 'none';
              } else {
                glbPoster.style.backgroundImage = `url('${glbPosterUrl}')`;
                glbPoster.classList.add('visible');
              }

              const oldPoster = document.querySelector('.poster-layer');
              if (oldPoster) oldPoster.remove();

              console.log('‚úÖ Poster adaptativo cargado:', glbPosterUrl);

              // ‚ñ∂ Listener del load del model-viewer
              mv.addEventListener('load', () => {
                // Espera un frame de render para asegurar que el modelo ya est√° visible
                requestAnimationFrame(() => {
                  if (glbPoster) {
                    glbPoster.classList.add('fade-out');
                    setTimeout(() => glbPoster.remove(), 700);
                  }
                });
              });

              mv.addEventListener('load', () => {
                // ... tu c√≥digo para ocultar skeleton ...

                // ya haces visible el modelo:
                requestAnimationFrame(() => mv.classList.add('is-visible'));

                // ‚ñ∂ Crossfade: poster GLB se desvanece tras un frame
                if (glbPoster) {
                  // da un peque√±o margen para que el modelo ya est√© pintado
                  setTimeout(() => {
                    glbPoster.classList.add('fade-out');
                    // limpia el DOM tras la animaci√≥n
                    setTimeout(() => {
                      glbPoster.remove();
                    }, 500); // ‚âà a tu transition .45s
                  }, 30);
                }
                // Modelo listo ‚Üí habilita AR
                setArEnabled(true);
              });
            }

            // Poster por pieza con fallback
            if (model !== 'cristo-yacente') {
              try {
                const posterSrc = `/assets/posters/${model}.webp`;
                if (await exists(posterSrc)) {
                  mv.poster = posterSrc;
                  mv.setAttribute('poster', posterSrc);
                } else {
                  mv.poster = '/models/placeholder.webp';
                  mv.setAttribute('poster', '/models/placeholder.webp');
                }
              } catch {
                mv.poster = '/models/placeholder.webp';
                mv.setAttribute('poster', '/models/placeholder.webp');
              }
            } else {
              // Limpiar poster para cristo-yacente
              mv.removeAttribute('poster');
              mv.poster = '';
            }

            // Config c√°mara
            const cam = cameraSettings[model];
            if (cam) {
              if (cam.orbit) mv.cameraOrbit = cam.orbit;
              if (cam.fov) mv.fieldOfView = cam.fov; // Added explicit FOV support
              if (cam.target) mv.cameraTarget = cam.target;
              if (cam.minRadius) mv.minCameraOrbit = `auto auto ${cam.minRadius}`;
              if (cam.maxRadius) mv.maxCameraOrbit = `auto auto ${cam.maxRadius}`;
              if (cam.minFov) mv.minFieldOfView = cam.minFov;
              if (cam.maxFov) mv.maxFieldOfView = cam.maxFov;
            }

            // === ENTORNO: usar HDR solo como luz; SIN skybox visible ===
            const HDR_PRIMARY = '/assets/hdr/studio_small_09_2k.hdr';
            const HDR_FALLBACK = 'neutral'; // si falla, luz neutra

            async function firstExisting(urls) {
              for (const u of urls) {
                try {
                  const r = await fetch(u, { method: 'HEAD', cache: 'force-cache' });
                  if (r.ok) return u;
                } catch { }
              }
              return '';
            }

            // Aplica solo iluminaci√≥n (environment-image). Elimina cualquier skybox.
            async function applyEnvironmentOnly(mv, hdrUrl) {
              const env = hdrUrl || 'neutral';
              mv.setAttribute('environment-image', env);
              mv.environmentImage = env;

              // üîí Sin skybox visible
              mv.removeAttribute('skybox-image');
              mv.skyboxImage = '';

              // Ajustes de look (ajusta a tu gusto)
              mv.exposure = '1.25';
              mv.shadowIntensity = '0.8';
              mv.shadowSoftness = '1.0';
              // mv.environmentRotation = '10deg'; // opcional
            }

            // Elegimos un HDR v√°lido (o neutro)
            const hdrToUse = (await firstExisting([HDR_PRIMARY])) || HDR_FALLBACK;

            // Ilumina sin fondo HDR
            await applyEnvironmentOnly(mv, hdrToUse);

            // Algunos navegadores ‚Äúresetean‚Äù atributos tras ciertos eventos: lo reforzamos
            mv.addEventListener('load', () => applyEnvironmentOnly(mv, hdrToUse), { once: true });



            // Iluminaci√≥n por pieza (opcional)
            const lightSettings = {
              'cristo-yacente': {
                exposure: 1.6,
                shadowIntensity: 0.9,
                shadowSoftness: 0.9,
                environmentRotation: '15deg'
              },
              'virgen-romanica': { exposure: 1.3, environmentRotation: '0deg' }
            };
            const L = lightSettings[model];
            if (L) {
              if (L.exposure != null) mv.exposure = String(L.exposure);
              if (L.shadowIntensity != null) mv.shadowIntensity = String(L.shadowIntensity);
              if (L.shadowSoftness != null) mv.shadowSoftness = String(L.shadowSoftness);
              if (L.environmentRotation) mv.environmentRotation = L.environmentRotation;
            }

            // iOS Quick Look
            mv.iosSrc = usdzUrl(model);
            mv.classList.remove('hidden');

            // Oculta bot√≥n AR nativo
            if (!mv.querySelector('[slot="ar-button"]')) {
              const blocker = document.createElement('button');
              blocker.setAttribute('slot', 'ar-button');
              blocker.setAttribute('aria-hidden', 'true');
              blocker.style.display = 'none';
              blocker.tabIndex = -1;
              mv.appendChild(blocker);
            }

            // ‚úÖ Bot√≥n AR unificado (optimizado y reseteado por carga)
            if (arBtn) {
              // Elimina handlers previos si la p√°gina fue recargada desde memoria
              arBtn.replaceWith(arBtn.cloneNode(true));
              const newArBtn = document.getElementById('arBtn');

              const fileSigned = preSigned?.glb || glbUrl(model);
              const intent = `intent://arvr.google.com/scene-viewer/1.0?file=${encodeURIComponent(
                fileSigned
              )}&mode=ar_preferred&title=${encodeURIComponent(model)}#Intent;scheme=https;package=com.google.android.googlequicksearchbox;action=android.intent.action.VIEW;end;`;


              newArBtn.classList.remove('hidden');
              newArBtn.addEventListener('click', async () => {
                // ‚úÖ VERIFICAR COOLDOWN: No permitir clicks m√∫ltiples
                const now = Date.now();
                const timeSinceLastClick = now - lastARClickTime;

                if (timeSinceLastClick < AR_COOLDOWN_MS) {
                  const remainingSeconds = Math.ceil((AR_COOLDOWN_MS - timeSinceLastClick) / 1000);
                  showToast(`Por favor espera ${remainingSeconds} segundos antes de volver a intentar`, 2000);

                  // Vibraci√≥n de feedback negativo
                  try {
                    if (navigator.vibrate) navigator.vibrate([50, 100, 50]);
                  } catch { }

                  return; // Salir sin hacer nada
                }

                // Actualizar timestamp del √∫ltimo click
                lastARClickTime = now;
                if (window.startCooldownVisual) window.startCooldownVisual(newArBtn || arBtn);

                // Mostrar overlay de carga inmediatamente
                showARLoading();

                try {
                  if (isIOS) {
                    const ok = openQuickLookSync(model);
                    if (!ok) window.location.href = usdzUrl(model);
                    return;
                  }



                  if (mv?.activateAR) await mv.activateAR();
                  else openARFor(model);
                } catch (err) {
                  console.error('Error abriendo AR:', err);
                  openARFor(model);
                } finally {
                  // hideARLoading();
                }
              });
            }

            if (slug) {
              infoData = await loadInfoDataOrFallback(infoData);
              renderInfo(slug);
            }

            // Auto-open si el usuario lo dej√≥ abierto para este slug o si viene con ?info=1 o #info
            const wantsInfo =
              new URLSearchParams(location.search).get('info') === '1' ||
              location.hash === '#info';
            let lastState = 'closed';
            try {
              lastState = localStorage.getItem(sheetKeyFor(slug)) || 'closed';
            } catch { }
            if (wantsInfo || lastState === 'open') {
              // Deja un frame para que el DOM pinte antes del open (suaviza la transici√≥n)
              requestAnimationFrame(() => openSheet());
            }

            await loadInfoData();
            setupAudioFor(model);
            skel.classList.add('hidden');
            return;
          }

          if (type === 'splat' && figure) {
            document.body.classList.add('mode-splat');

            // Deshabilita AR mientras el SPLAT no est√© listo
            setArEnabled(false);



            // Estado de carga + watchdog de seguridad
            let splatLoaded = false;
            const WATCHDOG_MS = 12000;

            const retrySplat = () => {
              // Reaparece el skeleton suavemente
              const sk = document.getElementById('skel');
              if (sk) {
                sk.classList.remove('hidden');
                sk.style.opacity = '1';
              }

              // Rehacer poster overlay si estaba
              const sp = document.getElementById('splatPoster');
              if (sp) {
                sp.classList.remove('hidden', 'fade-out');
                requestAnimationFrame(() => sp.classList.add('visible'));
              }

              // Cache-buster al iframe (usando & si ya hay ?)
              const bust = `${splat.src.includes('?') ? '&' : '?'}v=${Date.now()}`;
              splat.src = splatUrl(figure) + bust;

              // Reinicia estado
              splatLoaded = false;
              startWatchdog();
            };

            let watchdogTimer = null;
            function startWatchdog() {
              clearTimeout(watchdogTimer);
              watchdogTimer = setTimeout(() => {
                if (!splatLoaded) {
                  showErrorAndRetry('splat', figure, retrySplat);
                  // Al fallar, mantiene AR desactivado
                  setArEnabled(false);
                }
              }, WATCHDOG_MS);
            }

            // Si vuelve la conexi√≥n y a√∫n no carg√≥, reintenta
            window.addEventListener('online', () => {
              if (!splatLoaded) retrySplat();
            });

            // --- Poster previo al SPLAT (aparece ya, antes del src) ---
            const splatPoster = document.getElementById('splatPoster');
            if (splatPoster) {
              // Fallback inmediato
              splatPoster.style.backgroundImage = `url('/models/placeholder.webp')`;
              splatPoster.classList.remove('hidden');
              requestAnimationFrame(() => splatPoster.classList.add('visible'));
              startWatchdog();

              // Ocultar cuando el SPLAT carga
              splat.addEventListener(
                'load',
                () => {
                  splatLoaded = true;
                  clearTimeout(watchdogTimer);

                  splatPoster.classList.add('fade-out');
                  setTimeout(() => splatPoster.classList.add('hidden'), 700);

                  // SPLAT ya pintado ‚Üí habilita AR y muestra la escena
                  setArEnabled(true);
                  requestAnimationFrame(() => splat.classList.add('is-visible'));

                  // Oculta skeleton por si segu√≠a visible
                  const sk = document.getElementById('skel');
                  if (sk) {
                    sk.style.opacity = '0';
                    setTimeout(() => sk.classList.add('hidden'), 400);
                  }
                },
                { once: true }
              );
            }

            // Cargar SPLAT
            splat.src = splatUrl(figure);
            splat.classList.remove('is-visible');
            splat.classList.remove('hidden');

            // FAB AR
            arBtn.classList.remove('hidden');
            arBtn.addEventListener('click', async () => {
              // ‚úÖ VERIFICAR COOLDOWN
              const now = Date.now();
              const timeSinceLastClick = now - lastARClickTime;

              if (timeSinceLastClick < AR_COOLDOWN_MS) {
                const remainingSeconds = Math.ceil((AR_COOLDOWN_MS - timeSinceLastClick) / 1000);
                showToast(`Por favor espera ${remainingSeconds} segundos antes de volver a intentar`, 2000);
                try { if (navigator.vibrate) navigator.vibrate([50, 100, 50]); } catch { }
                return;
              }

              lastARClickTime = now;
              if (window.startCooldownVisual) window.startCooldownVisual(newArBtn || arBtn);
              showARLoading();
              if (isIOS) {
                const ok = openQuickLookSync(figure);
                if (!ok) window.location.href = usdzUrl(figure); // fallback duro
                return;
              }
              openARFor(figure);
            });

            if (slug) {
              infoData = await loadInfoDataOrFallback(infoData);
              renderInfo(slug);
            }

            // Auto-open si el usuario lo dej√≥ abierto para este slug o si viene con ?info=1 o #info
            const wantsInfo =
              new URLSearchParams(location.search).get('info') === '1' ||
              location.hash === '#info';
            let lastState = 'closed';
            try {
              lastState = localStorage.getItem(sheetKeyFor(slug)) || 'closed';
            } catch { }
            if (wantsInfo || lastState === 'open') {
              // Deja un frame para que el DOM pinte antes del open (suaviza la transici√≥n)
              requestAnimationFrame(() => openSheet());
            }

            await loadInfoData();
            setupAudioFor(figure);
            skel.classList.add('hidden');
            return;
          }

          // Sin par√°metros v√°lidos:
          showHelp();
        } catch (err) {
          console.error(err);
          msg.classList.remove('hidden');
          msg.innerHTML = `<b>Error:</b> ${String(err).replace(/</g, '&lt;')}`;
          skel.classList.add('hidden');
        }
        // ...otras funciones aqu√≠, como setupAudioFor(), openARFor(), etc.

        // ==== CARTELA DIN√ÅMICA (versi√≥n escritorio y m√≥vil) ====
        async function loadInfoData() {
          try {
            if (!slug) return;

            const response = await fetch('/assets/info.json');
            const data = await response.json();

            if (!data[slug]) {
              console.warn(`No se encontr√≥ informaci√≥n para ${slug}`);
              return;
            }

            const info = data[slug];
            const infoPanel = document.getElementById('infoPanel');
            if (!infoPanel) return;

            // Inserta la informaci√≥n en la cartela
            infoPanel.innerHTML = `
            <h2>${info.title}</h2>
            <div class="info-meta">${info.author} ¬∑ ${info.year}</div>
            <div class="info-desc">${info.desc}</div>

            <ul class="info-details">
            ${info.material ? `<li><strong>Material:</strong> ${info.material}</li>` : ""}
            ${(info.tipologia || info.typology) ? `<li><strong>Tipolog√≠a:</strong> ${info.tipologia || info.typology}</li>` : ""}
            ${(info.tecnica || info.technique) ? `<li><strong>T√©cnica:</strong> ${info.tecnica || info.technique}</li>` : ""}
            ${info.dimensions ? `<li><strong>Dimensiones:</strong> ${info.dimensions}</li>` : ""}
            ${info.year ? `<li><strong>Fecha:</strong> ${info.year}</li>` : ""}
            ${info.author ? `<li><strong>Autor:</strong> ${info.author}</li>` : ""}
            </ul>

            <div class="info-actions">
              <button id="audioGuideBtn" class="info-btn-audio">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polygon points="5 3 19 12 5 21 5 3"></polygon>
                </svg>
                Escuchar audiogu√≠a
              </button>

              <a href="/landing/" class="info-btn-visit">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
                  <polyline points="16 6 12 2 8 6"></polyline>
                  <line x1="12" y1="2" x2="12" y2="15"></line>
                </svg>
                Ir al museo
              </a>
            </div>
          `;

            // === PRELOAD AUDIO ===
            async function preloadAudio(slug) {
              try {
                const audioPath = `/assets/audio/${slug}.mp3`;
                const audio = new Audio(audioPath);
                audio.preload = "auto";
                console.log(`üéß Precargado: ${audioPath}`);
              } catch (err) {
                console.warn("Error precargando audio:", err);
              }
            }

          } catch (err) {
            console.error('Error cargando info.json:', err);
          }
        }

        // üëáüëá Mant√©n esto abajo del todo, antes del cierre:
      })();

    })();

    /* === PANEL VISUAL DE AJUSTE DE C√ÅMARA (con min/max zoom) === */
    (function setupCameraDebugPanel() {
      // SIEMPRE VISIBLE

      const qs = new URLSearchParams(location.search);
      let dbgModel = window.loadedModel || (qs.get('model') || qs.get('figure') || '').toLowerCase();

      // L√≥gica de fallback si no detecta nada
      if (!dbgModel) {
        const p = location.pathname.split('/').filter(Boolean);
        if (p[0] === 'splat' && p[1]) dbgModel = p[1];
        else if (p[0] === 'glb' && p[1]) dbgModel = p[1];
        else if (p.length === 1) dbgModel = p[0];
      }

      // DEFAULT FINAL
      if (!dbgModel) dbgModel = 'cristo-yacente';

      const model = dbgModel;
      console.log('üîå Debug Panel para:', model);

      const mv = document.getElementById('mv');
      if (!mv) {
        console.warn('üîå Debug Panel: No se ha encontrado el elemento #mv');
        return;
      }

      const num = (s, def = 0) => {
        if (s == null) return def;
        const m = String(s).match(/-?\d+(\.\d+)?/);
        return m ? parseFloat(m[0]) : def;
      };

      // Si no hay settings para este modelo, usar defaults gen√©ricos sin crashear
      const cam = (window.cameraSettings && window.cameraSettings[model]) || {};

      const initTheta = num((cam.orbit || '0deg 70deg 3m').split(' ')[0], 0);
      const initPhi = num((cam.orbit || '0deg 70deg 3m').split(' ')[1], 70);
      const initR = num((cam.orbit || '0deg 70deg 3m').split(' ')[2], 3);
      const initX = num((cam.target || '0m 0.5m 0m').split(' ')[0], 0);
      const initY = num((cam.target || '0m 0.5m 0m').split(' ')[1], 0.5);
      const initZ = num((cam.target || '0m 0.5m 0m').split(' ')[2], 0);
      const initMinR = num(cam.minRadius, Math.max(0.4, initR * 0.4));
      const initMaxR = num(cam.maxRadius, Math.max(initR * 1.5, initMinR + 0.5));
      const initFov = num(cam.fov || mv.fieldOfView || '30deg', 30);

      const panel = document.createElement('div');
      panel.id = 'camDebug';
      panel.style.cssText = `
          position: fixed; top: 120px; left: 20px; width: 280px;
          background: #ffffff; color: #000000; font: 14px/1.4 system-ui,sans-serif;
          border-radius: 12px; padding: 16px; z-index: 9999999; 
          border: 4px solid #ff0000; box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        `;
      panel.innerHTML = `
          <b style="color:#ff0000">üé• Ajuste de C√°mara (v2.1)</b><br>
          <small>Si no ves X/Z, haz Limpieza de Cach√©</small><br><br>

          <label>Target X (lateral): <span id="valX">${initX.toFixed(2)}</span> m</label><br>
          <input id="ctrlX" type="range" min="-2" max="2" step="0.01" value="${initX}"><br><br>

          <label>Altura (target Y): <span id="valY">${initY.toFixed(2)}</span> m</label><br>
          <input id="ctrlY" type="range" min="-1" max="4" step="0.01" value="${initY}"><br><br>

          <label>Target Z (profundidad): <span id="valZ">${initZ.toFixed(2)}</span> m</label><br>
          <input id="ctrlZ" type="range" min="-2" max="2" step="0.01" value="${initZ}"><br><br>

          <label>Distancia inicial (radius): <span id="valR">${initR.toFixed(1)}</span> m</label><br>
          <input id="ctrlR" type="range" min="0.5" max="30" step="0.1" value="${initR}"><br><br>

          <label>Giro horizontal (theta): <span id="valTheta">${initTheta.toFixed(0)}</span>¬∞</label><br>
          <input id="ctrlTheta" type="range" min="-180" max="180" step="1" value="${initTheta}"><br><br>

          <label>Elevaci√≥n (phi): <span id="valPhi">${initPhi.toFixed(0)}</span>¬∞</label><br>
          <input id="ctrlPhi" type="range" min="0" max="180" step="1" value="${initPhi}"><br><br>

          <label>FOV (zoom √≥ptico): <span id="valFov">${initFov.toFixed(0)}</span>¬∞</label><br>
          <input id="ctrlFov" type="range" min="15" max="75" step="1" value="${initFov}"><br><br>

          <hr style="border-color:#2a2f38; opacity:.4; margin:8px 0">

          <label>Zoom m√≠nimo (minRadius): <span id="valMinR">${initMinR.toFixed(1)}</span> m</label><br>
          <input id="ctrlMinR" type="range" min="0.4" max="60" step="0.1" value="${initMinR}"><br><br>

          <label>Zoom m√°ximo (maxRadius): <span id="valMaxR">${initMaxR.toFixed(1)}</span> m</label><br>
          <input id="ctrlMaxR" type="range" min="0.5" max="80" step="0.1" value="${initMaxR}"><br><br>

          <button id="copyCam" style="width:100%; padding:8px; border:none; background:#40cbcb; color:#fff; font-weight:700; border-radius:8px; cursor:pointer;">
            üìã Copiar valores
          </button>
        `;
      document.body.appendChild(panel);

      const yRange = panel.querySelector('#ctrlY');
      const rRange = panel.querySelector('#ctrlR');
      const phiRange = panel.querySelector('#ctrlPhi');
      const fovRange = panel.querySelector('#ctrlFov');
      const minRRange = panel.querySelector('#ctrlMinR');
      const maxRRange = panel.querySelector('#ctrlMaxR');

      const valY = panel.querySelector('#valY');
      const valR = panel.querySelector('#valR');
      const valPhi = panel.querySelector('#valPhi');
      const valFov = panel.querySelector('#valFov');
      const valMinR = panel.querySelector('#valMinR');
      const valMaxR = panel.querySelector('#valMaxR');

      function clampLimits() {
        let minR = parseFloat(minRRange.value);
        let r = parseFloat(rRange.value);
        let maxR = parseFloat(maxRRange.value);

        if (minR > maxR - 0.1) minR = maxR - 0.1;
        if (r < minR) r = minR;
        if (r > maxR) r = maxR;

        minRRange.value = minR.toFixed(1);
        rRange.value = r.toFixed(1);
        maxRRange.value = maxR.toFixed(1);

        valMinR.textContent = minR.toFixed(1);
        valR.textContent = r.toFixed(1);
        valMaxR.textContent = maxR.toFixed(1);
        return { minR, r, maxR };
      }

      function updateCamera() {
        const x = parseFloat(panel.querySelector('#ctrlX').value);
        const y = parseFloat(panel.querySelector('#ctrlY').value);
        const z = parseFloat(panel.querySelector('#ctrlZ').value);
        const theta = parseFloat(panel.querySelector('#ctrlTheta').value);
        const phi = parseFloat(phiRange.value);
        const fov = parseFloat(fovRange.value);
        const { minR, r, maxR } = clampLimits();

        panel.querySelector('#valX').textContent = x.toFixed(2);
        valY.textContent = y.toFixed(2);
        panel.querySelector('#valZ').textContent = z.toFixed(2);
        panel.querySelector('#valTheta').textContent = theta.toFixed(0);
        valPhi.textContent = phi.toFixed(0);
        valFov.textContent = fov.toFixed(0);

        mv.minCameraOrbit = `auto auto ${minR}m`;
        mv.maxCameraOrbit = `auto auto ${maxR}m`;
        mv.cameraTarget = `${x}m ${y}m ${z}m`;
        mv.cameraOrbit = `${theta}deg ${phi}deg ${r}m`;
        mv.fieldOfView = `${fov}deg`;
        mv.jumpCameraToGoal();
      }

      [panel.querySelector('#ctrlX'), yRange, panel.querySelector('#ctrlZ'), panel.querySelector('#ctrlTheta'), rRange, phiRange, fovRange, minRRange, maxRRange].forEach((i) =>
        i.addEventListener('input', updateCamera)
      );

      updateCamera();

      panel.querySelector('#copyCam').onclick = () => {
        const x = panel.querySelector('#ctrlX').value;
        const y = yRange.value;
        const z = panel.querySelector('#ctrlZ').value;
        const theta = panel.querySelector('#ctrlTheta').value;
        const text = `
"${model || 'cristo-yacente'}": {
  orbit: "${theta}deg ${phiRange.value}deg ${rRange.value}m",
  target: "${x}m ${y}m ${z}m",
  minRadius: "${minRRange.value}m",
  maxRadius: "${maxRRange.value}m",
  minFov: "22deg",
  maxFov: "${fovRange.value}deg"
},`.trim();
        navigator.clipboard.writeText(text);
        const btn = panel.querySelector('#copyCam');
        btn.textContent = '‚úÖ Copiado';
        setTimeout(() => (btn.textContent = 'üìã Copiar valores'), 1200);
      };
    })();

    /* === Interacci√≥n t√°ctil para arrastrar la cartela (UX mejorado + fix reopen) === */
    (function enableInfoSheetDrag() {
      const sheet = document.getElementById('infoSheet');
      const infoBtn = document.getElementById('infoBtn');
      if (!sheet || !infoBtn) return;

      let startY = 0;
      let currentY = 0;
      let isDragging = false;
      const threshold = 90; // p√≠xeles de arrastre necesarios para cerrar

      const onStart = (e) => {
        if (e.touches?.length !== 1) return;
        startY = e.touches[0].clientY;
        isDragging = true;
        sheet.style.transition = 'none';
      };

      const onMove = (e) => {
        if (!isDragging || e.touches?.length !== 1) return;
        currentY = e.touches[0].clientY - startY;
        if (currentY > 0) {
          sheet.style.transform = `translateY(${currentY}px)`;
          sheet.style.opacity = `${1 - Math.min(currentY / 250, 0.4)}`;
        }
      };

      const closeSheetSmooth = () => {
        sheet.style.transition = 'transform .28s ease, opacity .28s ease';
        sheet.style.transform = 'translateY(100%)';
        sheet.style.opacity = '0';
        // peque√±o retraso para permitir la animaci√≥n antes del hidden
        setTimeout(() => {
          sheet.classList.add('hidden');
          sheet.setAttribute('aria-hidden', 'true');
          sheet.style.transform = '';
          sheet.style.opacity = '';
        }, 280);
      };

      const onEnd = () => {
        if (!isDragging) return;
        sheet.style.transition = 'transform .28s ease, opacity .28s ease';
        if (currentY > threshold) {
          closeSheetSmooth();
        } else {
          sheet.style.transform = 'translateY(0)';
          sheet.style.opacity = '1';
        }
        isDragging = false;
        startY = 0;
        currentY = 0;
      };

      // Escuchar gestos t√°ctiles
      sheet.addEventListener('touchstart', onStart, { passive: true });
      sheet.addEventListener('touchmove', onMove, { passive: true });
      sheet.addEventListener('touchend', onEnd);
    })();

    /* üîí Bloquear page-zoom del navegador solo cuando el gesto ocurre sobre la UI */
    (function preventPageZoomOnUI() {
      const uiRoots = ['#topBar', '#infoSheet', '#fabRow'];

      const isInUI = (target) => {
        if (!target || !target.closest) return false;
        return uiRoots.some((sel) => target.closest(sel));
      };

      /* iOS: gesturestart/gesturechange ‚Üí pinch page-zoom */
      const onGesture = (e) => {
        if (isInUI(e.target)) {
          e.preventDefault(); // requiere passive:false
        }
      };
      document.addEventListener('gesturestart', onGesture, {
        passive: false,
        capture: true
      });
      document.addEventListener('gesturechange', onGesture, {
        passive: false,
        capture: true
      });

      /* Trackpad pinch (Ctrl+wheel) en Desktop ‚Üí evita zoom si es sobre UI */
      window.addEventListener(
        'wheel',
        (e) => {
          if (e.ctrlKey && isInUI(e.target)) {
            e.preventDefault();
          }
        },
        { passive: false, capture: true }
      );

      /* Evitar double-tap zoom en iOS SOLO en UI */
      let lastTouchEnd = 0;
      const onTouchEnd = (e) => {
        if (!isInUI(e.target)) return;
        const now = Date.now();
        if (now - lastTouchEnd < 350) {
          e.preventDefault(); // suprime double-tap zoom
        }
        lastTouchEnd = now;
      };
      document.addEventListener('touchend', onTouchEnd, {
        passive: false,
        capture: true
      });

      /* Extra: evita scroll-bounce que a veces dispara zoom accidental en UI */
      const onTouchMove = (e) => {
        if (isInUI(e.target)) {
          // permitimos desplazamiento en la cartela, pero no ‚Äúpinch zoom‚Äù de p√°gina
          if (e.scale && e.scale !== 1) e.preventDefault();
        }
      };
      document.addEventListener('touchmove', onTouchMove, {
        passive: false,
        capture: true
      });

      /* === Carga de p√≥sters adaptativos (desktop vs m√≥vil) === */
      (function loadAdaptivePoster() {
        const viewerContainer = document.getElementById('viewerContainer');
        if (!viewerContainer) return;

        // Detectar slug actual (ya lo tienes en URL)
        const qs = new URLSearchParams(location.search);
        const slug =
          qs.get('model') ||
          qs.get('figure') ||
          location.pathname.split('/').filter(Boolean).pop() ||
          '';

        if (!slug) return;

        // Detectar tipo de dispositivo
        const isDesktop = window.matchMedia('(min-width: 1024px)').matches;
        const folder = isDesktop ? 'desktop' : 'mobile';
        const posterUrl = `/assets/posters/${folder}/${slug}.webp`;

        // Crear capa si no existe
        let posterLayer = document.querySelector('#viewerContainer .poster-layer');
        if (!posterLayer) {
          posterLayer = document.createElement('div');
          posterLayer.className = 'poster-layer';
          viewerContainer.prepend(posterLayer);
        }

        // Aplicar imagen y fade
        posterLayer.style.backgroundImage = `url('${posterUrl}')`;
        posterLayer.style.opacity = '1';

        // Quitar el p√≥ster cuando el viewer cargue
        const mv = document.getElementById('mv');
        const splat = document.getElementById('splat');

        const hidePoster = () => {
          posterLayer.classList.add('hidden');
          setTimeout(() => posterLayer.remove(), 600);
        };

        mv?.addEventListener('load', hidePoster, { once: true });
        splat?.addEventListener('load', hidePoster, { once: true });
      })();

      // ==== SPLAT POSTER (a√±adido manualmente) ====
      const splatPoster = document.getElementById('splatPoster');
      const splatIframe = document.getElementById('splat');

      if (splatPoster && splatIframe) {
        const isDesktop = window.matchMedia('(min-width: 1024px)').matches;
        const posterPath = isDesktop
          ? `/assets/posters/desktop/splat-poster.webp`
          : `/assets/posters/mobile/splat-poster.webp`;

        splatPoster.style.backgroundImage = `url('${posterPath}?v=${Date.now()}')`;

        splatIframe.addEventListener('load', () => {
          requestAnimationFrame(() => {
            splatPoster.classList.add('fade-out');
            setTimeout(() => splatPoster.remove(), 800);
          });
        });
      }
    })();
  </script>
  <!-- ==== REGISTRO DEL SERVICE WORKER ==== -->
  <script>
    // --- Swipe down para cerrar la cartela m√≥vil ---
    (function () {
      const sheet = document.getElementById('infoSheet');
      const dragHandle = document.querySelector('.info-sheet__drag');
      if (!sheet || !dragHandle) return;

      let startY = 0;
      let currentY = 0;
      let isDragging = false;

      const onTouchStart = (e) => {
        startY = e.touches[0].clientY;
        isDragging = true;
        sheet.style.transition = 'none';
      };

      const onTouchMove = (e) => {
        if (!isDragging) return;
        currentY = e.touches[0].clientY;
        const diff = currentY - startY;

        // Solo desplazamos hacia abajo
        if (diff > 0) {
          sheet.style.transform = `translateY(${diff}px)`;
          sheet.style.opacity = `${Math.max(1 - diff / 300, 0.4)}`;
        }
      };

      const onTouchEnd = () => {
        if (!isDragging) return;
        isDragging = false;
        sheet.style.transition = 'transform 0.25s ease, opacity 0.25s ease';

        const diff = currentY - startY;
        if (diff > 120) {
          // cerrar cartela
          sheet.classList.add('hidden');
          sheet.setAttribute('aria-hidden', 'true');
          document.body.classList.remove('sheet-open');
        } else {
          // volver a su sitio
          sheet.style.transform = '';
          sheet.style.opacity = '';
        }
      };

      dragHandle.addEventListener('touchstart', onTouchStart);
      dragHandle.addEventListener('touchmove', onTouchMove);
      dragHandle.addEventListener('touchend', onTouchEnd);
    })();

    // Registro del Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(reg => console.log('‚úÖ Service Worker registrado para el visor'))
          .catch(err => console.warn('‚ùå Error registrando SW:', err));
      });
    }
  </script>
  <script src="/assets/debug-overlay.js"></script>
</body>

</html>
<script>
  // ========================================
  // HELPERS COOLDOWN VISUAL (Inyectado)
  // ========================================
  window.startCooldownVisual = function (btn) {
    if (!btn) return;
    btn.classList.add('is-cooldown');
    const originalText = btn.querySelector('.ar-text')?.textContent || 'Ver en AR';

    let remaining = Math.ceil(7); // 7s hardcoded por seguridad
    const updateText = () => {
      const txt = btn.querySelector('.ar-text');
      if (txt) txt.textContent = `Espere ${remaining}s...`;
    };

    updateText();

    const interval = setInterval(() => {
      remaining--;
      if (remaining <= 0) {
        clearInterval(interval);
        btn.classList.remove('is-cooldown');
        const txt = btn.querySelector('.ar-text');
        if (txt) txt.textContent = 'Ver en AR';
      } else {
        updateText();
      }
    }, 1000);
  };
</script>